<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>SolverViet Chat</title><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"><link rel="icon" type="image/png" href="{{ url_for('static', filename='logos/favicon.png') }}"><script>const currentUsername = "{{ username }}";</script>
<style>body{margin:0;background-color:#121212;color:white;font-family:Arial,sans-serif}.header{padding:15px 20px;font-size:1.5rem;font-weight:bold;background-color:#1e1e1e}.search-bar{padding:10px 20px}.search-bar input{width:100%;padding:12px;border-radius:20px;background-color:#2a2a2a;border:none;color:white;font-size:1rem}.avatar-row{display:flex;gap:20px;padding:20px;overflow-x:auto;white-space:nowrap}.friend-avatar{text-align:center;cursor:pointer;width:70px}.avatar-default{width:64px;height:64px;background-color:#3a3a3a;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:white;margin-bottom:5px;position:relative}.header{padding:20px 28px;font-size:2rem;font-weight:bold;background-color:#0e0e0e;display:flex;justify-content:space-between;align-items:center;border-bottom:2px solid #00aaff}.logo{font-size:2rem}.back-link{font-size:1.2rem;color:#00aaff;text-decoration:none;margin-left:auto;padding:6px 12px;border:1px solid #00aaff;border-radius:8px;transition:background-color 0.3s,color 0.3s;cursor:pointer;user-select:none;white-space:nowrap}.back-link:hover{background-color:#00aaff;color:#fff}#show-requests-btn:hover{background-color:#0088cc;box-shadow:0 0 14px #0088cc}#friend-requests-popup button:hover{background-color:#0088cc}.badge{position:absolute;top:-5px;right:-5px;background-color:#ff3b3b;color:white;padding:2px 6px;font-size:0.75rem;border-radius:12px;font-weight:bold;z-index:10}.image-popup{font-size:0.7rem;background-color:#00aaff;color:white;border-radius:6px;padding:2px 6px;margin-top:4px;animation:fadeIn 0.5s ease-in-out;white-space:nowrap}@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}#avatar-modal{display:none;cursor:zoom-out}.privacy-tab-btn{background:#2a2a2a;border:none;padding:6px 10px;border-radius:8px;color:white;cursor:pointer;font-weight:bold}.privacy-tab-btn:hover{background:#ffaa00;color:black}.friend-avatar.glow{box-shadow:0 0 16px 4px #00aaff;transition:box-shadow 0.2s ease;border-radius:50%}</style></head>
<style>.back-link svg {transition: fill 0.3s; } .back-link:hover svg { fill: #fff; }</style>
<body>
<div class="header"><div class="logo">Solver<span style="color:#00aaff">Viet</span></div><a href="/" class="back-link" title="Trang ch·ªß"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#00aaff" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></a></div>
<div class="search-bar-container" style="display: flex; align-items: center; padding: 10px 20px; gap: 14px; flex-direction: row-reverse;">
<div class="search-bar" style="flex: 1;"><input id="search-input" type="text" placeholder="T√¨m b·∫°n ho·∫∑c ƒëo·∫°n chat..."style="width: 100%; padding: 12px; border-radius: 20px; background-color: #2a2a2a; border: none; color: white; font-size: 1rem;"></div>
<div style="text-align: center;">
<div style="position: relative; cursor: pointer; margin-bottom: 4px;" title="B·∫°n l√† {{ fullname or username }}"onclick="openProfile()">
<img src="{{ user_avatar if user_avatar else url_for('static', filename='logos/logo.png') }}"
onerror="this.onerror=null; this.src='{{ url_for('static', filename='logos/logo.png') }}';"
style="width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 2px solid #00aaff;" />
{% if True %}
<div class="status-dot" style="position:absolute; bottom: 2px; right: 2px; width: 10px; height: 10px; background-color: {{ 'green' if is_online else '#888' }}; border: 2px solid #121212; border-radius: 50%;"></div>
</div>
{% endif %}
<div style="font-size: 0.9rem; color: #ccc; max-width: 66px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
{{ (fullname or username) }}
</div>
{% if bio %}
<div style="font-size: 0.75rem; color: #00aaff; margin-top: 4px; max-width: 72px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
{{ bio[:70] }}{% if bio|length > 70 %}...{% endif %}
</div>
{% endif %}
</div>
</div>
<div id="search-results" style="padding: 10px 20px; color: white;"></div>
<div class="avatar-row" id="friend-list"></div>
<div id="no-friends-message" style="text-align: center; width: 100%; margin-top: 120px; display: none;"><h2 style="color: #888; font-weight: 500;"></h2>Ch·ªçn 1 ng∆∞·ªùi b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán<br>ho·∫∑c t√¨m b·∫°n b√® tr√™n thanh t√¨m ki·∫øm.</h2></div>
<div id="friend-requests-popup"style="display:none;position:fixed;bottom:80px;right:20px;background:#222;color:white;padding:15px 20px;border-radius:12px;max-width:320px;max-height:420px;overflow-y:auto;box-shadow: 0 0 15px #00aaff;font-family: 'Segoe UI', sans-serif;z-index: 10000;">
<h4 style="margin-top:0; margin-bottom:12px; font-weight:600; font-size:1.2rem;">L·ªùi m·ªùi k·∫øt b·∫°n</h4>
<div id="friend-requests-list" style="font-size: 0.95rem;"></div>
<button onclick="closeFriendRequests()"style="margin-top:15px;background:#00aaff;border:none;color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600;transition: background-color 0.3s ease;">ƒê√≥ng</button>
</div>
<div style="position: fixed; bottom: 20px; right: 20px; z-index: 10001;">
<button id="show-requests-btn"title="L·ªùi m·ªùi k·∫øt b·∫°n"style="background:#00aaff;border:none;color:white;padding:12px 14px;border-radius:50%;cursor:pointer;box-shadow: 0 0 10px #00aaff;font-size: 18px;display: flex;align-items: center;justify-content: center;transition: background-color 0.3s ease;"><i class="fas fa-user-plus"></i></button>
<span id="invite-badge" style="position: absolute;top: -5px;right: -5px;background: red;color: white;font-size:0.65rem;padding: 2px 5px;border-radius: 50%;display: none;font-weight: bold;">0</span>
</div>
<script>
function goToChat(username) {window.location.href = "/chat/" + username;}
const searchInput = document.querySelector('.search-bar input');const searchResults = document.getElementById('search-results');const friendRequestsPopup = document.getElementById('friend-requests-popup');const friendRequestsList = document.getElementById('friend-requests-list');const showRequestsBtn = document.getElementById('show-requests-btn');
showRequestsBtn.addEventListener('click', () => {loadFriendRequests();friendRequestsPopup.style.display = 'block';});
function closeFriendRequests() {friendRequestsPopup.style.display = 'none';}
searchInput.addEventListener('input', () => {const query = searchInput.value.trim();if (query.length < 2) {searchResults.innerHTML = '';return;}
fetch(`/users/search?q=${encodeURIComponent(query)}`)
.then(res => res.json())
.then(users => {
if (users.length === 0) {
searchResults.innerHTML = 'Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng n√†o.';
return;
}
renderSearchResults(users);
})
.catch(err => {
searchResults.innerHTML = 'L·ªói khi t√¨m ki·∫øm.';
console.error(err);
});
});
function sendFriendRequest(toUsername) { fetch('/friends/request', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ to_user: toUsername }) }).then(res => res.json()).then(data => { if (data.success) { showFriendToast(" ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n!"); searchInput.value = ''; searchResults.innerHTML = ''; } else { alert('L·ªói: ' + data.message); } }); }
function loadFriendRequests() { fetch('/friends/requests').then(res => res.json()).then(requests => { if (requests.length === 0) { friendRequestsList.innerHTML = 'Kh√¥ng c√≥ l·ªùi m·ªùi k·∫øt b·∫°n.'; return; } friendRequestsList.innerHTML = requests.map(r => `<div class="friend-request" data-username="${r.from_username}" style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #444;"><span>${r.from_name || r.from_username} (${r.from_username})</span><div><button onclick="acceptFriendRequest('${r.from_username}')" style="background:#28a745; border:none; color:white; border-radius:4px; cursor:pointer; margin-right:5px;">Ch·∫•p nh·∫≠n</button><button onclick="rejectFriendRequest('${r.from_username}')" style="background:#dc3545; border:none; color:white; border-radius:4px; cursor:pointer;">T·ª´ ch·ªëi</button></div></div>`).join(''); }); }
function acceptFriendRequest(fromUsername) { fetch('/friends/requests/accept', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ from_user: fromUsername }) }).then(res => res.json()).then(data => { if (data.success) { showFriendToast("ƒê√£ ch·∫•p nh·∫≠n l·ªùi m·ªùi!"); const item = document.querySelector(`.friend-request[data-username="${fromUsername}"]`); if (item) item.remove(); if (document.querySelectorAll('.friend-request').length === 0) { friendRequestsList.innerHTML = 'Kh√¥ng c√≥ l·ªùi m·ªùi k·∫øt b·∫°n.'; } loadFriendList(); addFriendAvatar(fromUsername, data.from_name); } else { alert('L·ªói: ' + data.message); } }); }
function rejectFriendRequest(fromUsername) { fetch('/friends/requests/reject', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ from_user: fromUsername }) }).then(res => res.json()).then(data => { if (data.success) { showFriendToast(" ƒê√£ t·ª´ ch·ªëi l·ªùi m·ªùi!"); const item = document.querySelector(`.friend-request[data-username="${fromUsername}"]`); if (item) item.remove(); if (document.querySelectorAll('.friend-request').length === 0) { friendRequestsList.innerHTML = 'Kh√¥ng c√≥ l·ªùi m·ªùi k·∫øt b·∫°n.'; } } else { alert('L·ªói: ' + data.message); } }); }
function addFriendAvatar(username, displayName, unreadCount = 0, imageOnly = false, isOnline = false, hideAvatar = false, avatar = '', bio = '') { const avatarRow = document.getElementById('friend-list'); const friendDiv = document.createElement('div'); friendDiv.className = 'friend-avatar'; friendDiv.addEventListener('mousedown', (e) => handleFriendHold(e, username, displayName)); friendDiv.addEventListener('click', (e) => handleFriendClick(e, username)); friendDiv.setAttribute('onmousedown', `handleFriendHold(event, '${username}', '${displayName}')`); const defaultUrl = '/static/logos/logo.png'; const avatarUrl = hideAvatar ? defaultUrl : `/static/images/avatars/${username}_avatar.png`; const isCurrentUser = String(username) === String(currentUsername); const statusColor = isOnline ? '#00ff00' : '#888'; friendDiv.innerHTML = `<div class="avatar-default" style="padding: 0; position: relative;"><img src="${avatarUrl}" onerror="this.onerror=null; this.src='${defaultUrl}';" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover;" />${unreadCount > 0 && !imageOnly ? `<div class="badge">${unreadCount > 99 ? '+99' : '+' + unreadCount}</div>` : ''}</div><div style="text-align: center; max-width: 70px; overflow: hidden;"><div class="friend-name" data-username="${username}" style="font-size: 0.85rem; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${displayName}">${displayName}</div>${bio ? `<div style="font-size: 0.7rem; color: #00aaff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${bio}</div>` : ''}</div>${imageOnly ? `<div class="image-popup">üì∑ ${displayName} ƒë√£ g·ª≠i 1 ·∫£nh</div>` : ''}`; avatarRow.appendChild(friendDiv); }
let oldFriendList = [];
function loadFriendList() { fetch('/friends/list').then(res => res.json()).then(friends => { const container = document.getElementById('friend-list'); const noFriendsMsg = document.getElementById('no-friends-message'); if (friends.length < 10) { noFriendsMsg.style.display = 'block'; } else { noFriendsMsg.style.display = 'none'; } const oldUsernames = oldFriendList.map(f => f.username || f); const newUsernames = friends.map(f => f.username || f); if (JSON.stringify(oldUsernames) === JSON.stringify(newUsernames)) return; container.innerHTML = ''; friends.forEach(f => { const uname = f.username || f; if (String(uname) === String(currentUsername)) return; const displayName = localStorage.getItem('friend_name_' + uname) || f.display_name || uname; addFriendAvatar(uname, displayName, f.unread || 0, f.image_only || false, f.is_online || false, f.hide_avatar || false, '', f.bio || ''); }); oldFriendList = friends; document.querySelectorAll('.friend-name').forEach(el => { const username = el.dataset.username; const customName = localStorage.getItem('friend_name_' + username); if (customName) el.textContent = customName; }); }); }
setInterval(loadFriendList, 15000);
loadFriendList();
</script>
<div id="user-popup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);background:#fff; padding:20px; border-radius:12px; box-shadow:0 0 20px rgba(0,0,0,0.3); z-index:9999; min-width:260px; text-align:center;">
<img id="popup-avatar" src="" style="width:80px; height:80px; border-radius:50%; border:2px solid #00aaff; object-fit:cover;">
<h3 id="popup-name" style="margin-top:10px; font-size:20px;"></h3>
<p id="popup-username" style="color:gray; margin-bottom:15px;"></p>
<button id="popup-add-btn" class="btn btn-primary">K·∫øt b·∫°n</button>
<br><br>
<button onclick="closePopup()" style="border:none; background:none; color:#aaa; cursor:pointer;">ƒê√≥ng</button>
</div>
<script>
function showUserPopup(user){if(user.is_friend){window.location.href=`/chat/${user.username}`;return;}const avatarElem=document.getElementById('popup-avatar');avatarElem.src=user.avatar_url;avatarElem.onclick=function(){document.getElementById('avatar-modal-img').src=user.avatar_url;document.getElementById('avatar-modal').style.display='flex';};document.getElementById('popup-name').innerText=user.name||user.username;document.getElementById('popup-username').innerText='@'+user.username;document.getElementById('popup-add-btn').onclick=function(){sendFriendRequest(user.username);closePopup();};document.getElementById('user-popup').style.display='block';}
function closePopup(){document.getElementById('user-popup').style.display='none';}
</script>
<div id="avatar-modal" onclick="this.style.display='none'"style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;background-color:rgba(0,0,0,0.8); z-index:99999; justify-content:center; align-items:center;">
<img id="avatar-modal-img" src=""style="max-width:90%; max-height:90%; border-radius:12px; box-shadow:0 0 20px rgba(0,0,0,0.4);">
</div>
<div id="profile-overlay" onclick="closeProfile()" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh;background: rgba(0,0,0,0.5); z-index:9998;"></div>
<div id="profile-popup" onclick="event.stopPropagation()" style="display:none; position:fixed; top:50%; left:50%;transform:translate(-50%,-50%); background:#1e1e1e; padding:20px; border-radius:12px;box-shadow:0 0 20px #00aaff; color:white; z-index:9999; width:320px; position:relative;">
<i class="bi bi-gear-fill"onclick="openPrivacySettings()"title="C√†i ƒë·∫∑t ri√™ng t∆∞"style="position: absolute; top: 18px; left: 16px; font-size: 20px; color: white; cursor: pointer; opacity: 0.85;"></i>
<h3 style="text-align: center; margin-top:0;"> H·ªì s∆° c√° nh√¢n</h3>
<div style="text-align:center; margin-bottom: 16px;">
<img src="{{ user_avatar if user_avatar else url_for('static', filename='logos/logo.png') }}"onerror="this.onerror=null; this.src='{{ url_for('static', filename='logos/logo.png') }}';"style="width: 90px; height: 90px; border-radius: 50%; object-fit: cover;border: 2px solid #00aaff; box-shadow: 0 0 8px #00aaff; cursor: zoom-in;"onclick="showImageModal(this.src)" />
</div>
<label>T√™n trang c√° nh√¢n:</label>
<input id="edit-fullname" type="text"value="{{ current_user.fullname or '' }}"style="width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:none;">
<label>M√£ ID:</label>
<div style="display: flex; gap: 6px; align-items: center; margin-bottom: 10px; position: relative;">
<input id="user-id" value="{{ user_id }}" readonly style="flex: 1; padding: 8px; border-radius: 6px; border: none; background: #2a2a2a; color: white;" />
<button onclick="copyUserId()" title="Sao ch√©p ID"style="padding: 6px 10px; background: #00aaff; border: none; border-radius: 6px; cursor: pointer;">
<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="white" viewBox="0 0 16 16"><path d="M10 1.5A1.5 1.5 0 0 1 11.5 3v1h-1V3a.5.5 0 0 0-.5-.5H5A1.5 1.5 0 0 0 3.5 4v8A1.5 1.5 0 0 0 5 13.5h5A1.5 1.5 0 0 0 11.5 12v-1h1v1A2.5 2.5 0 0 1 10 14.5H5A2.5 2.5 0 0 1 2.5 12V4A2.5 2.5 0 0 1 5 1.5h5z"/><path d="M13.5 4.5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0-.5.5v8a.5.5 0 0 0 .5.5h5a.5.5 0 0 0 .5-.5v-8z"/></svg></button>
<div id="copy-tooltip" style="position: absolute;right: 0;top: -30px;background: #00cc88;color: white;padding: 4px 10px;border-radius: 6px;font-size: 0.85rem;display: none;white-space: nowrap;box-shadow: 0 2px 8px rgba(0,0,0,0.4);">ƒê√£ sao ch√©p!</div>
</div>
<label>M√¥ t·∫£ (tu·ª≥ ch·ªçn):</label>
<textarea id="edit-bio" style="width:100%; padding:8px; height:60px; border-radius:6px; border:none;"></textarea>
<div style="text-align:right; margin-top:12px;">
<button onclick="saveProfile()" style="background:#00aaff; border:none; padding:8px 14px; border-radius:6px; color:white;">L∆∞u</button>
<button onclick="closeProfile()" style="margin-left:10px; background:none; border:none; color:#aaa;">ƒê√≥ng</button>
</div>
</div>
<div id="privacy-popup" onclick="event.stopPropagation()" style="display:none; position:fixed; top:50%; left:50%;transform:translate(-50%,-50%); background:#1e1e1e; padding:20px; border-radius:12px;box-shadow:0 0 20px #00aaff; color:white; z-index:9999; width:340px;">
<h3 style="margin-top:0; margin-bottom: 16px;"> C√†i ƒë·∫∑t ri√™ng t∆∞</h3>
<label><input type="checkbox" id="hide-online"> ·∫®n tr·∫°ng th√°i ho·∫°t ƒë·ªông</label><br>
<label><input type="checkbox" id="hide-avatar"> ·∫®n ·∫£nh ƒë·∫°i di·ªán</label><br>
<label><input type="checkbox" id="hide-bio"> ·∫®n ghi ch√∫ (bio)</label><br>
<label><input type="checkbox" id="hide-all"> ·∫®n danh ho√†n to√†n (·∫©n m·ªçi th·ª©)</label><br>
<hr style="margin: 16px 0; border-color: #444;">
<div>
<strong> Danh s√°ch ƒë√£ ch·∫∑n:</strong>
<ul id="blocked-users-list" style="list-style:none; padding-left:0; font-size: 0.95rem; margin-top: 10px;"></ul>
</div>
<div style="text-align:right; margin-top:16px;">
<button onclick="savePrivacySettings()" style="background:#00aaff; border:none; padding:8px 14px; border-radius:6px; color:white;">L∆∞u</button>
<button onclick="closePrivacySettings()" style="margin-left:10px; background:none; border:none; color:#aaa;">ƒê√≥ng</button>
</div>
</div>
<script>
function openProfile(){fetch('/get_profile').then(res=>res.json()).then(data=>{document.getElementById("edit-fullname").value=data.fullname||'';document.getElementById("edit-bio").value=data.bio||'';document.getElementById("profile-popup").style.display='block';document.getElementById("profile-overlay").style.display='block';});}
function closeProfile() { document.getElementById("profile-popup").style.display = "none";document.getElementById("privacy-popup").style.display = "none";document.getElementById("profile-overlay").style.display = "none";}
function saveProfile(){const f=document.getElementById("edit-fullname").value,b=document.getElementById("edit-bio").value;fetch("/update_profile",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fullname:f,bio:b})}).then(res=>res.json()).then(data=>{if(data.success){showProfileToast("H·ªì s∆° ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!");closeProfile();setTimeout(()=>location.reload(),1000);}else{showProfileToast("‚ùå L·ªói khi l∆∞u h·ªì s∆°: "+data.message,false);}}).catch(()=>{showProfileToast("‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß!",false);});}
</script>
<div id="image-modal" style="display: none;position: fixed;top: 0; left: 0;width: 100%; height: 100%;background-color: rgba(0, 0, 0, 0.8);justify-content: center;align-items: center;z-index: 9999;"onclick="hideImageModal()">
<img id="modal-image" src=""style="max-width: 90%;max-height: 90%;border-radius: 12px;box-shadow: 0 0 12px #00aaff;">
</div>
<script>
function showImageModal(s){document.getElementById("modal-image").src=s;document.getElementById("image-modal").style.display="flex";}
function hideImageModal(){document.getElementById("image-modal").style.display="none";}
</script>
<script>
function copyUserId(){const i=document.getElementById("user-id"),t=document.getElementById("copy-tooltip");navigator.clipboard.writeText(i.value).then(()=>{t.style.display="block";setTimeout(()=>{t.style.display="none"},1500)})}
function showProfileToast(m,s=true){const t=document.getElementById("profile-toast");t.innerText=m;t.style.backgroundColor=s?"#00cc88":"#ff4444";t.style.display="block";t.style.opacity="1";setTimeout(()=>{t.style.opacity="0";setTimeout(()=>{t.style.display="none"},300)},2200)}
</script>
<div id="profile-toast" style="position: fixed;bottom: 20px;left: 50%;transform: translateX(-50%);background-color: #00cc88;color: white;padding: 10px 20px;border-radius: 8px;font-size: 0.95rem;box-shadow: 0 0 12px rgba(0,0,0,0.3);display: none;z-index: 99999;transition: opacity 0.3s ease;"></div>
<script>
function openPrivacySettings(){document.getElementById("profile-popup").style.display="none";document.getElementById("privacy-popup").style.display="block";document.getElementById("profile-overlay").style.display="block";fetch("/get_profile").then(r=>r.json()).then(d=>{const p=d.privacy||{};document.getElementById("hide-online").checked=p.hide_online||false;document.getElementById("hide-avatar").checked=p.hide_avatar||false;document.getElementById("hide-bio").checked=p.hide_bio||false;document.getElementById("hide-all").checked=p.hide_all||false;});fetch("/blocked_users").then(r=>r.json()).then(users=>{const list=document.getElementById("blocked-users-list");list.innerHTML="";if(users.length===0){list.innerHTML="<li style='color: #aaa;'>Kh√¥ng c√≥ ai b·ªã ch·∫∑n</li>";return;}users.forEach(u=>{const li=document.createElement("li");li.innerHTML=`<span>@${u}</span><button onclick="unblockUser('${u}')" style="margin-left:10px; background:#ff4444; border:none; color:white; padding:4px 8px; border-radius:4px;">B·ªè ch·∫∑n</button>`;list.appendChild(li);});});}
function backToProfile() {document.getElementById("privacy-popup").style.display = "none";document.getElementById("profile-popup").style.display = "block";}
</script>
<script>
function switchPrivacyTab(tabId){document.querySelectorAll('.privacy-tab').forEach(el=>el.style.display='none');document.getElementById('privacy-tab-'+tabId).style.display='block';document.querySelectorAll('.privacy-tab-btn').forEach(btn=>btn.style.background='');event.target.style.background='#ffaa00';}
function backToProfile() {document.getElementById("privacy-popup").style.display = "none";document.getElementById("profile-popup").style.display = "block";}
function blockUser(){let name=document.getElementById("block-username").value.trim();if(name){const li=document.createElement("li");li.innerHTML=name+` <button onclick="this.parentElement.remove()" style="margin-left:8px;">‚ùå</button>`;document.getElementById("blocked-users").appendChild(li);document.getElementById("block-username").value="";}}
function confirmCleanup() {const user = document.getElementById("cleanup-username").value.trim();if (user && confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën xo√° s·∫°ch ƒëo·∫°n chat v√† ·∫£nh v·ªõi "${user}" kh√¥ng?`)) {alert(` ƒê√£ ƒë√°nh d·∫•u ƒë·ªÉ xo√° d·ªØ li·ªáu v·ªõi ${user}`);}}
function savePrivacySettings(){const data={hide_online:document.getElementById("hide-online").checked,hide_avatar:document.getElementById("hide-avatar").checked,hide_bio:document.getElementById("hide-bio").checked,hide_all:document.getElementById("hide-all").checked,blocked_users:Array.from(document.querySelectorAll("#blocked-users li")).map(li=>li.innerText.replace(" ‚ùå","").trim())};fetch("/update_privacy",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then(res=>res.json()).then(resp=>{if(resp.success){showPrivacyToast("ƒê√£ l∆∞u c√†i ƒë·∫∑t ri√™ng t∆∞!");closeProfile()}else{showPrivacyToast("L·ªói khi l∆∞u: "+resp.error,false)}});}
function unblockUser(username){if(confirm(`B·∫°n mu·ªën b·ªè ch·∫∑n @${username}?`)){fetch("/unblock_user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target:username})}).then(res=>res.json()).then(data=>{if(data.status==="success"){openPrivacySettings();showPrivacyToast("ƒê√£ b·ªè ch·∫∑n @"+username);}})}}
function showPrivacyToast(message,isSuccess=true){const toast=document.getElementById("privacy-toast");toast.innerText=(isSuccess?"‚úÖ ":"‚ùå ")+message;toast.style.background=isSuccess?"#00cc88":"#ff4444";toast.style.display="block";setTimeout(()=>{toast.style.display="none"},3000);}
let unblockTarget = "";
function unblockUser(username){unblockTarget=username;document.getElementById("unblock-user-name").textContent="@"+username;document.getElementById("unblockConfirmModal").style.display="flex";}
function closeUnblockConfirm() {document.getElementById("unblockConfirmModal").style.display = "none";}
function confirmUnblock(){fetch("/unblock_user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target:unblockTarget})}).then(res=>res.json()).then(data=>{if(data.status==="success"){showUnblockToast();closeUnblockConfirm();openPrivacySettings();}});}
function showUnblockToast(){const toast=document.getElementById("unblock-toast");toast.style.display="block";setTimeout(()=>{toast.style.opacity="0";setTimeout(()=>{toast.style.display="none";toast.style.opacity="1";},600);},2000);}
function showFriendToast(message){const toast=document.getElementById("friend-toast");toast.innerText=message;toast.style.display="block";toast.style.opacity="1";setTimeout(()=>{toast.style.opacity="0";setTimeout(()=>{toast.style.display="none";},300);},2500);}
let pendingRemoveUsername = "";
function showRemoveFriendPopup(username,displayName){popupActive=true;pendingRemoveUsername=username;document.getElementById("remove-friend-msg").innerText=`B·∫°n mu·ªën xo√° b·∫°n b√® v·ªõi "${displayName}"?`;document.getElementById("remove-friend-popup").style.display="block";}
function closeRemoveFriendPopup() { popupActive = false;document.getElementById("remove-friend-popup").style.display = "none";pendingRemoveUsername = "";}
function confirmRemoveFriend(){if(!pendingRemoveUsername)return;fetch('/friends/remove',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({target_user:pendingRemoveUsername})}).then(res=>res.json()).then(data=>{if(data.success){showFriendToast(" "+data.message);loadFriendList();}else{alert("L·ªói: "+data.message);}closeRemoveFriendPopup();});}
let popupActive = false;
let holdTimer = null;
function handleFriendHold(event,username,displayName){if(event.button!==0)return;const target=event.currentTarget;holdTimer=setTimeout(()=>{target.classList.add('glow');setTimeout(()=>{showRemoveFriendPopup(username,displayName);target.classList.remove('glow');},200);},700);document.addEventListener('mouseup',()=>{clearTimeout(holdTimer);target.classList.remove('glow');},{once:true});}
function handleFriendClick(event, username) {if (popupActive) {event.preventDefault(); return;}goToChat(username); }
</script>
<div id="privacy-toast" style="position: fixed; bottom: 24px; right: 24px; background: #00cc88; color: white; padding: 10px 16px; border-radius: 8px; font-size: 0.95rem;box-shadow: 0 4px 12px rgba(0,0,0,0.4); display: none; z-index: 99999;">ƒê√£ l∆∞u c√†i ƒë·∫∑t ri√™ng t∆∞!</div>
<div id="unblockConfirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;background-color: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center;">
<div style="background:white; padding:20px; border-radius:12px; max-width:400px; width:90%; position:relative;"><h5>X√°c nh·∫≠n b·ªè ch·∫∑n</h5><p>B·∫°n c√≥ ch·∫Øc mu·ªën b·ªè ch·∫∑n <span id="unblock-user-name" style="font-weight:bold;"></span>?</p>
<div style="text-align:right;"><button class="btn btn-secondary me-2" onclick="closeUnblockConfirm()">Hu·ª∑</button><button class="btn btn-danger" onclick="confirmUnblock()">B·ªè ch·∫∑n</button></div>
<button onclick="closeUnblockConfirm()" style="position:absolute; top:10px; right:14px; border:none; background:none; font-size:20px;">&times;</button>
</div>
</div>
<div id="unblock-toast" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);background:#00c853;color:white;padding:12px 24px;border-radius:10px;font-weight:500;font-size:1rem; z-index:99999;box-shadow:0 6px 20px rgba(0,0,0,0.25);"> ƒê√£ b·ªè ch·∫∑n th√†nh c√¥ng.</div>
<div id="friend-toast" style="position: fixed;bottom: 30px;left: 50%;transform: translateX(-50%);background-color: #00aaff;color: white;padding: 10px 20px;border-radius: 10px;font-size: 0.95rem;box-shadow: 0 4px 12px rgba(0,0,0,0.3);z-index: 99999;display: none;opacity: 0;transition: opacity 0.4s ease;">ƒê√£ g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n!</div>
<div id="remove-friend-popup" style="display:none; position:fixed; top:50%; left:50%;transform:translate(-50%, -50%); background:#1e1e1e; padding:20px; border-radius:12px;box-shadow:0 0 20px #00aaff; color:white; z-index:9999; min-width:280px; text-align:center;">
<p id="remove-friend-msg" style="margin-bottom:20px;"></p>
<button onclick="confirmRemoveFriend()" style="background:#ff4444; border:none; padding:8px 14px; color:white; border-radius:6px;">OK</button>
<button onclick="closeRemoveFriendPopup()" style="margin-left:10px; background:none; border:none; color:#ccc;">ƒê√≥ng</button>
</div>
<div id="friend-toast" style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%);background:#222; color:white; padding:12px 20px; border-radius:8px; box-shadow:0 0 12px #00aaff;font-weight:bold; display:none; z-index:9999; transition: all 0.3s ease;"></div>
<script>
function updateUnreadBadges(){fetch("/chat/unread_status").then(res=>res.json()).then(data=>{document.querySelectorAll(".friend-name").forEach(el=>{const username=el.dataset.username;const badge=el.querySelector(".unread-badge");if(data[username]){badge?.classList.remove("hidden");}else{badge?.classList.add("hidden");}});});}
updateUnreadBadges();setInterval(updateUnreadBadges, 5000);
</script>
<script>
const pendingInvites={{ pending_invites or 0 }};const badge=document.getElementById("invite-badge");if(pendingInvites>0){badge.innerText=pendingInvites>9?"9+":pendingInvites;badge.style.display="inline-block";}else{badge.style.display="none";}
</script>
<script>
function renderSearchResults(users){const searchResults=document.getElementById("search-results");searchResults.innerHTML="";users.forEach(u=>{const div=document.createElement("div");div.style.cssText="display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid #444; cursor:pointer;";div.innerHTML=`<img src="${u.avatar_url||'/static/logos/logo.png'}" style="width:42px; height:42px; border-radius:50%; object-fit:cover; border:1px solid #00aaff;"><div><div style="font-weight:600;">${u.name||u.username}</div><div style="font-size: 0.85rem; color: #aaa;">@${u.username}</div></div>`;div.onclick=()=>{if(u.is_friend){window.location.href="/chat/"+u.username;}else{showUserPopup(u);}};searchResults.appendChild(div);});}</script>
</body></html>