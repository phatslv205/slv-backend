
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <title>Solver</title>


  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logos/favicon.png') }}">
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>

  <style>
    body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    display: flex;
    flex-direction: column;
    height: 100vh;
    transition: background-color 0.3s ease, color 0.3s ease;
}

/* üå§Ô∏è Giao di·ªán s√°ng */
body:not(.dark) {
    background-color: #ffffff;
    color: #000000;
}

/* üåô Giao di·ªán t·ªëi */
body.dark {
    background-color: #1e1e1e;
    color: #ffffff;
}


    header {
      background-color: #009688;
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    }
    #back-btn {
      background: none;
      border: 1px solid white;
      color: white;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
    }

    #chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 12px;
      overflow-y: auto;
    }

    .message {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    margin: 6px 0;
    display: inline-block;
    line-height: 1.5;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    animation: slideIn 0.2s ease-in-out; /* ‚úÖ Hi·ªáu ·ª©ng tr∆∞·ª£t v√†o nh·∫π nh√†ng */
  }


   .user {
      background-color: #00bcd4; /* xanh cyan s√°ng hi·ªán ƒë·∫°i */
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }


    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .block {
    margin: 16px 0;
    padding: 12px 16px;
    border-radius: 10px;
    background-color: #2b2b2b;
    line-height: 1.6;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
  }

  .block.formula {
    border-left: 5px solid #5fa8d3;
  }

  .block.quick {
    border-left: 5px solid #4caf50;
    background-color: #1d331d;
  }

  .block.full {
    border-left: 5px solid #9c27b0;
    background-color: #251a2b;
  }

  .block b {
    color: #fff;
    font-size: 16px;
  }
  .dot:nth-child(1) { animation-delay: 0s; }
  .dot:nth-child(2) { animation-delay: 0.2s; }
  .dot:nth-child(3) { animation-delay: 0.4s; }



  @keyframes fadeInUp {
    0% { opacity: 0; transform: translateY(10px); }
    100% { opacity: 1; transform: translateY(0); }
  }

  .message.bot {
    background-color: transparent; /* Xo√° n·ªÅn x√°m */
    color: #ddd;
    align-self: flex-start;
    border-radius: 0;
    box-shadow: none;
    animation: fadeInUp 0.25s ease-out;
    padding: 8px 4px;
    margin: 12px 0;
    max-width: 90%;
    font-size: 15px;
    line-height: 1.7;
  }
  .dot {
    animation: blink 1.2s infinite;
    font-weight: bold;
  }

  @keyframes blink {
    0% { opacity: 0.2; }
    50% { opacity: 1; }
    100% { opacity: 0.2; }
  }
  .alert {
    animation: slideUp 0.6s ease;
    color: orange;
    font-size: 14px;
    text-align: center;
    margin-top: 6px;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(15px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
    .chat-bar {
    max-width: 700px;
    width: 100%;
    display: flex;
    align-items: center;
    background-color: #2a2b32;
    border-radius: 999px;
    padding: 12px 20px;
    margin: auto;
  }
  .chat-bar input {
    flex-grow: 1;
    background: transparent;
    border: none;
    outline: none;
    color: white;
    font-size: 16px;
  }
  .chat-bar button {
    background: none;
    border: none;
    color: white;
    margin-left: 10px;
    cursor: pointer;
  }
  .chat-bar i {
    width: 20px;
    height: 20px;
  }
  .logo-section {
  display: flex;
  align-items: center;
  gap: 10px;
  }

  .brand-name {
    font-size: 20px;
    font-weight: bold;
    letter-spacing: 1px;
  }

  .highlight {
    color: #ffc107;
  }

  #back-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    background-color: transparent;
    border: 1px solid white;
    color: white;
    padding: 6px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  #back-btn:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }
  .brand-name {
  font-size: 25px;         /* üëà nh·ªè l·∫°i cho g·ªçn */
  font-weight: bold;
  color: #00aaff;          /* üëà xanh n∆∞·ªõc bi·ªÉn */
  margin-left: 10px;
}
#suggestions-bar span {
  display: inline-block;
  background-color: #2e2e2e;
  color: #00bcd4;
  border-radius: 20px;
  padding: 6px 14px;
  margin: 4px 6px;
  font-size: 14px;
  cursor: pointer;
  transition: background-color 0.2s ease;
}
#suggestions-bar span:hover {
  background-color: #3a3a3a;
}
.plus-container {
  position: relative;
}

.plus-menu {
  display: none;
  position: absolute;
  bottom: 50px;
  left: 0;
  min-width: 220px; /* ‚úÖ R·ªông h∆°n */
  background-color: #2e2e2e;
  padding: 10px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
  z-index: 10;
}


.plus-menu button {
  display: flex;
  align-items: center;
  background: none;
  border: none;
  color: white;
  gap: 12px;
  padding: 10px 16px;
  cursor: pointer;
  width: 100%;
  font-size: 15px;
  transition: background-color 0.2s;
}


.plus-menu button:hover {
  background-color: #444;
  border-radius: 6px;
}

#image-preview img {
  max-height: 60px;
  border-radius: 6px;
  margin-top: 4px;
}
#file-preview {
  align-items: center;
  margin-top: 4px;
}

@keyframes mic-pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.7);
  }
  70% {
    box-shadow: 0 0 0 12px rgba(0, 230, 118, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(0, 230, 118, 0);
  }
}

#mic-wrapper.active {
  animation: mic-pulse 1.2s infinite;
  border: 2px solid #00e676;
}
.chat-notice {
  background-color: #2a2a2a;
  color: #d0d0d0;
  padding: 10px 14px;
  margin-top: 12px;
  border-left: 5px solid #00c4ff;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 500;
  line-height: 1.6;
  text-align: center;
}
.chat-notice span {
  color: #00c4ff;
  font-weight: 600;
  cursor: pointer;
  text-decoration: underline;
}
.chat-notice span:hover {
  color: #00e0ff;
  text-shadow: 0 0 4px #00e0ff;
}

.message-actions {
  margin-top: 6px;
  padding: 6px 10px;
  background-color: #262626; /* n·ªÅn ƒë·∫≠m v·ª´a ph·∫£i */
  border-radius: 999px;
  display: inline-flex;
  gap: 10px;
  align-items: center;
  font-size: 17px;
  box-shadow: 0 0 2px rgba(255,255,255,0.1);
}


.copy-btn {
  background-color: #343434;
  border: 1px solid #555;
  padding: 4px 8px;
  border-radius: 6px; /* Vu√¥ng nh·∫π h∆°n */
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background-color 0.2s ease, transform 0.2s ease;
  margin-right: 4px; /* üëâ T√°ch kh·ªèi emoji */
}

.copy-btn:hover {
  background-color: #4e4e4e;
  transform: scale(1.05);
}

.copy-btn svg {
  width: 18px;
  height: 18px;
  stroke: #00bcd4;  /* Xanh cyan ƒë·∫≠m */
 /* V√†ng n·ªïi b·∫≠t */
  stroke-width: 2;
}

.copy-btn:hover svg {
  stroke: white;
}
.copy-btn:hover {
  background-color: #555;
  transform: scale(1.08);
  box-shadow: 0 0 6px rgba(255,255,255,0.2);
}



.emoji-btn {
  cursor: pointer;
  transition: transform 0.2s;
}
.emoji-btn:hover {
  transform: scale(1.2);
}
.flying-emoji {
  position: fixed;
  font-size: 28px;
  animation: flyUp 1s ease-out forwards;
  pointer-events: none;
  z-index: 9999;
}
@keyframes flyUp {
  0% {
    opacity: 1;
    transform: translateY(0);
  }
  100% {
    opacity: 0;
    transform: translateY(-100px);
  }
}
.copy-container {
  background-color: #2e2e2e;
  padding: 4px 10px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  box-shadow: 0 0 2px rgba(255,255,255,0.1);
}

.emoji-container {
  background-color: #2e2e2e;
  padding: 4px 12px;
  border-radius: 999px;
  display: flex;
  gap: 10px;
  align-items: center;
  box-shadow: 0 0 2px rgba(255,255,255,0.1);
}
.send-icon-btn {
  background-color: #00c4ff;   /* gi·ªëng m√†u ƒêƒÉng xu·∫•t */
  border: none;
  padding: 10px 14px;
  border-radius: 50%;
  cursor: pointer;
  transition: background-color 0.25s, transform 0.15s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.send-icon-btn:hover {
  background-color: #00e0ff;
  transform: scale(1.1);
  box-shadow: 0 0 8px rgba(0, 255, 255, 0.4);
}

.send-icon-btn i {
  stroke: white;
  stroke-width: 2;
  width: 20px;
  height: 20px;
}


  </style>
  <style>
  .image-viewer-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); display: flex;
    justify-content: center; align-items: center;
    z-index: 1000; display: none;
  }
  .image-viewer-overlay img {
    max-width: 90%; max-height: 90%;
    box-shadow: 0 0 12px rgba(255,255,255,0.6);
  }
  
  .upload-effect i {
  color: white;
  transition: color 0.2s ease;
}

.upload-effect:hover i {
  color: #00d4ff; /* ho·∫∑c m√†u b·∫°n mu·ªën */
}

</style>

<style>
  .upload-effect.effect {
    animation: pop-effect 0.3s ease-in-out;
  }

  @keyframes pop-effect {
    0% {
      transform: scale(1);
      filter: brightness(1);
    }
    50% {
      transform: scale(1.2);
      filter: brightness(1.5);
    }
    100% {
      transform: scale(1);
      filter: brightness(1);
    }
  }


</style>

<style>
.emoji-btn svg {
  stroke: white;
  transition: stroke 0.2s ease;
}

.emoji-btn:hover svg {
  stroke: #00d4ff; /* xanh c√¥ng ngh·ªá */
}

</style>
<style>
  .emoji-suggest {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    padding: 8px;
    font-size: 22px;
    animation: fadeIn 0.3s ease;
  }
  .emoji-suggest span {
    cursor: pointer;
    transition: transform 0.2s;
  }
  .emoji-suggest span:hover {
    transform: scale(1.2);
  }
  .hidden {
    display: none;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>


</head>
<body>
<header style="background-color: #111; color: white; padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #00bcd4;">
<div style="display: flex; flex-direction: column;">
  <span style="font-size: 22px; font-weight: bold; color: #00bcd4;">SolverViet</span>
  <span style="font-size: 12px; color: #aaa; margin-top: 2px;">¬© 2025. All rights reserved.</span>
  <small style="color:#888; font-size:12px; margin-top: 4px;">
  Solver Chat l√† tr·ª£ l√Ω h·ªçc t·∫≠p th√¥ng minh, ƒë∆∞·ª£c ƒëi·ªÅu ch·ªânh ƒë·ªÉ mang ƒë·∫øn tr·∫£i nghi·ªám th√¢n thi·ªán, t·ª± nhi√™n v√† g·∫ßn g≈©i nh·∫•t v·ªõi ng∆∞·ªùi Vi·ªát.

  </small>
</div>
{% if message_from_home %}
  <div style="background-color: #330000; color: #ff6666; text-align: center; padding: 12px 16px; margin: 12px 0; border-radius: 10px; font-weight: 500;">
    üö´ {{ message_from_home }}
  </div>
{% endif %}

 
  <div>
    <a href="/logout" style="color: #00bcd4; margin-right: 20px; text-decoration: none;">ƒêƒÉng xu·∫•t</a>
    <a href="/" style="color: #00bcd4; text-decoration: none;">Quay l·∫°i trang ch·ªß</a>
  </div>
</header>

<div id="chat-container"></div>





{% if not user_vip_gpt and user_lite_exhausted %}
<div class="alert">üîí B·∫°n ƒë√£ d√πng h·∫øt 10 l∆∞·ª£t AI mi·ªÖn ph√≠. üëâ <a href="/upgrade">N√¢ng c·∫•p ngay</a> ƒë·ªÉ ti·∫øp t·ª•c s·ª≠ d·ª•ng.</div>
{% endif %}
<div id="suggestions-bar" style="text-align:center; margin-bottom: 8px;"></div>
<div id="input-area">

  <div class="chat-bar">
   

<div class="plus-container">
  <button onclick="togglePlusMenu()">
    <i data-lucide="plus" id="plus-icon"></i>
  </button>

  <div id="plus-menu" class="plus-menu">
    <!-- N√∫t G·ª≠i File -->
    <button
      onclick="{% if user_vip_gpt %}document.getElementById('file-input').click(){% else %}showVipWarning(){% endif %}"
      {% if not user_vip_gpt %}style="opacity:0.5; cursor:not-allowed;"{% endif %}
    >
      <i data-lucide="file"></i> <span>G·ª≠i file</span>
    </button>
    <input type="file" id="file-input" style="display:none;" onchange="previewGeneralFile(event)" />

    <!-- N√∫t Album -->
    <button
      onclick="{% if user_vip_gpt %}openAlbum(){% else %}showVipWarning(){% endif %}"
      {% if not user_vip_gpt %}style="opacity:0.5; cursor:not-allowed;"{% endif %}
    >
      <i data-lucide="image"></i> <span>Album ·∫£nh</span>
    </button>

    <!-- N√∫t Chia s·∫ª v·ªã tr√≠ -->
    <button
      onclick="{% if user_vip_gpt %}shareLocation(){% else %}showVipWarning(){% endif %}"
      {% if not user_vip_gpt %}style="opacity:0.5; cursor:not-allowed;"{% endif %}
    >
      <i data-lucide="map-pin"></i> <span>Chia s·∫ª v·ªã tr√≠</span>
    </button>

    <!-- N√∫t ƒêo·∫°n chat m·ªõi (d√πng cho m·ªçi user) -->
    <button onclick="startNewChat()">
      <i data-lucide="plus-circle"></i> <span>ƒêo·∫°n chat m·ªõi</span>
    </button>

  </div>
</div>




  <div id="image-preview" style="margin-top: 8px;"></div>
  <div id="file-preview" style="margin-top: 8px;"></div>
     

    <input id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeydown="handleKey(event)" />
     <div id="smart-emoji-suggestion" class="emoji-suggest hidden"></div>
<button id="emoji-toggle" onclick="toggleEmojiPicker()" title="Ch·ªçn emoji" class="emoji-btn">
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" stroke="currentColor"
       stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="10"/>
    <path d="M8 15s1.5 2 4 2 4-2 4-2"/>
    <circle cx="9" cy="10" r="1.2"/>
    <circle cx="15" cy="10" r="1.2"/>
  </svg>
</button>





   <button id="upload-btn" class="upload-effect" onclick="document.getElementById('upload-input').click()">
  <i data-lucide="image"></i>
</button>

    <input type="file" id="upload-input" accept="image/*" multiple onchange="handleImages(event)" style="display: none;" />

    <div id="mic-wrapper" style="display:inline-block; border-radius: 50%;">

  

    <button id="micBtn" onclick="startVoiceRecognition()"><i data-lucide="mic"></i></button>
  </div>


<button id="send-btn" onclick="sendMessage()" data-api="{{ '/gpt_viet_chat' if user_vip_gpt else '/chat_ai_lite' }}" class="send-icon-btn">
  <i data-lucide="send"></i>
</button>


  <div id="emojiPopup" style="display: none; position: fixed; bottom: 120px; right: 100px; z-index: 999;">
  <emoji-picker></emoji-picker>
</div>

  </div>
 
</div>
<div id="emoji-popup" style="display: none; position: fixed; bottom: 120px; right: 100px; z-index: 9999;"></div>

  
  <p id="ai-warning" style="color: orange; font-size: 13px; text-align: center;">
    ‚ö†Ô∏è AI c√≥ th·ªÉ qu√©t sai ƒë·ªÅ ho·∫∑c x·ª≠ l√Ω ƒë√∫ng kho·∫£ng 85%. Vui l√≤ng ki·ªÉm tra l·∫°i c√°c k·∫øt qu·∫£ quan tr·ªçng tr∆∞·ªõc khi s·ª≠ d·ª•ng nh√©!
  </p>
   
<script>
let pendingImages = [];

function handleImages(event) {
  const files = Array.from(event.target.files);
  const preview = document.getElementById('image-preview');

  for (const file of files) {
    if (pendingImages.length >= 5) {
      alert("‚ö†Ô∏è B·∫°n ch·ªâ c√≥ th·ªÉ g·ª≠i t·ªëi ƒëa 5 ·∫£nh m·ªói l·∫ßn.");
      break;
    }

    pendingImages.push(file);
  }

  updatePreview();
}

function updatePreview() {
  const preview = document.getElementById('image-preview');
  preview.innerHTML = '';

  pendingImages.forEach((img, i) => {
    const imgURL = URL.createObjectURL(img);
    const wrapper = document.createElement("div");
    wrapper.className = "preview-img";
    wrapper.style = "position: relative; display: inline-block; margin: 6px;";
    wrapper.innerHTML = `
      <img src="${imgURL}" style="max-height:100px; border-radius: 8px;">
      <button onclick="removeImage(${i})" style="position: absolute; top: -6px; right: -6px; background: #e53935; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer;">√ó</button>
    `;
    preview.appendChild(wrapper);
  });
}

function removeImage(index) {
  pendingImages.splice(index, 1);
  updatePreview();
  document.getElementById('upload-input').value = null;  // ‚ö†Ô∏è QUAN TR·ªåNG
}
function removeGeneralFile() {
  selectedGeneralFile = null;
  document.getElementById("file-input").value = '';
  document.getElementById("file-preview").innerHTML = '';
}

let chat_history = [];

function removeOldActions() {
  const oldActions = document.querySelectorAll('.message .message-actions');
  oldActions.forEach(el => el.remove());
}



async function sendMessage() { 
  const api_url = document.getElementById('send-btn').getAttribute('data-api');

  console.log("‚úÖ API ƒë∆∞·ª£c ch·ªçn:", api_url);

  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if (!msg && pendingImages.length === 0 && !selectedGeneralFile) return;



  const container = document.getElementById('chat-container');

  // üëâ Hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng
  const userMsg = document.createElement('div');
  userMsg.className = 'message user';

  // Hi·ªÉn th·ªã h√¨nh ·∫£nh n·∫øu c√≥
  if (pendingImages.length > 0) {
    pendingImages.forEach((imgFile) => {
    const img = document.createElement("img");
    img.className = "chat-image";
    img.src = URL.createObjectURL(imgFile);
    img.style.maxWidth = '150px';
    img.style.borderRadius = '8px';
    img.style.marginBottom = '6px';
    img.style.marginRight = '6px';
    userMsg.appendChild(img);
  });

  }

  // Hi·ªÉn th·ªã file n·∫øu c√≥
  if (selectedGeneralFile) {
    const fileLink = document.createElement("a");
    fileLink.href = URL.createObjectURL(selectedGeneralFile);
    fileLink.download = selectedGeneralFile.name;
    fileLink.innerText = `üìé ${selectedGeneralFile.name}`;
    fileLink.style.color = "#00bcd4";
    fileLink.style.display = "block";
    fileLink.style.marginTop = "6px";
    fileLink.style.textDecoration = "underline";
    userMsg.appendChild(fileLink);
  }

  // Hi·ªÉn th·ªã tin nh·∫Øn vƒÉn b·∫£n n·∫øu c√≥
  if (msg) {
    const text = document.createElement("div");
    text.innerText = msg;
    userMsg.appendChild(text);
  }

  emojiBox.classList.add("hidden");

  container.appendChild(userMsg);
  input.value = '';
  // ‚è±Ô∏è D·ªçn tr∆∞·ªõc UI
 document.getElementById("image-preview").innerHTML = '';
  document.getElementById("file-preview").innerHTML = '';
  document.getElementById("file-input").value = '';
  document.getElementById("upload-input").value = '';


 // ‚úÖ N·∫øu l√† y√™u c·∫ßu t·∫°o ·∫£nh ‚Üí ch·ªâ t·∫°o ·∫£nh, kh√¥ng g·ª≠i GPT n·ªØa
const imagePromptRegex = /(v·∫Ω|minh ho·∫°|minh h·ªça|h√¨nh ·∫£nh|v·∫Ω h√¨nh|tranh|v·∫Ω minh ho·∫°|·∫£nh minh ho·∫°)/i;

if (imagePromptRegex.test(msg)) {
  tryGenerateImageIfPrompted(msg);
  pendingImages = [];
  document.getElementById('upload-input').value = '';
  return; // ‚õî D·ª´ng l·∫°i, kh√¥ng g·ª≠i GPT n·ªØa
}





    // ‚úÖ ·∫®n ·∫£nh ƒë√£ ch·ªçn ngay sau khi g·ª≠i
  document.getElementById('image-preview').innerHTML = '';

  container.scrollTop = container.scrollHeight;


  const botLoading = document.createElement('div');
  botLoading.className = 'message bot';

  let isMath = false;
  if (pendingImages.length > 0) {
  isMath = true;
  }
  else if (msg) {
      isMath = isMathExpression(msg);
    }
    

  const loadingText = isMath ? "ƒêang Tr·∫£ l·ªùi" : "ƒêang So·∫°n Tin";

  botLoading.innerHTML = `
    <span style="color:gray; font-style: italic">
      ${loadingText}<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>
    </span>
  `;



  botLoading.id = 'bot-typing';
  container.appendChild(botLoading);
  container.scrollTop = container.scrollHeight;

  let data;

  const formData = new FormData();
formData.append('message', msg);
if (selectedGeneralFile) {
  formData.append("file", selectedGeneralFile);
}


// G·ª≠i t·ªëi ƒëa 5 ·∫£nh
pendingImages.forEach((img, i) => formData.append(`image_${i}`, img));

// G·ª≠i c·∫£ l·ªãch s·ª≠ h·ªôi tho·∫°i (n·∫øu c√≥)
formData.append('history', JSON.stringify(chat_history));

const res = await fetch(api_url, {
  method: 'POST',
  body: formData
});


data = await res.json();



function tryGenerateImageIfPrompted(userText) {
  const container = document.getElementById("chat-container");

  // üëâ Hi·ªáu ·ª©ng: "ƒêang t·∫°o ·∫£nh..."
  const loadingImage = document.createElement("div");
  loadingImage.className = "message bot";
  loadingImage.id = "image-creating";
  loadingImage.innerHTML = `
    <span style="color:gray; font-style: italic">
      ƒêang t·∫°o ·∫£nh<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>
    </span>
  `;
  container.appendChild(loadingImage);
  container.scrollTop = container.scrollHeight;

  // G·ª≠i request t·∫°o ·∫£nh
  fetch("/generate_image", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt: userText })
  })
  .then(res => res.json())
  .then(data => {
    // ‚ùå Xo√° hi·ªáu ·ª©ng loading
    const loading = document.getElementById("image-creating");
    if (loading) loading.remove();

    if (data.img_url) {
      const figureMsg = document.createElement("div");
      figureMsg.className = "message bot";

      const caption = document.createElement("div");
      caption.innerText = "üñºÔ∏è ƒê√¢y l√† ·∫£nh minh ho·∫° tui t·∫°o theo y√™u c·∫ßu n√®:";
      caption.style = "margin-bottom: 6px;";
      figureMsg.appendChild(caption);

      const link = document.createElement("a");
      link.href = data.img_url;
      link.download = "";
      link.target = "_blank";

      const img = document.createElement("img");
      img.className = "chat-image";
      img.src = data.img_url;
      img.style = "max-width: 360px; border-radius: 8px; margin-top: 6px; cursor: pointer;";
      img.title = "üñ±Ô∏è B·∫•m ƒë·ªÉ l∆∞u ·∫£nh v·ªÅ m√°y";

      link.appendChild(img);
      figureMsg.appendChild(link);

      container.appendChild(figureMsg);
      container.scrollTop = container.scrollHeight;
    }
  });
}


// N·∫øu c√≥ message ‚Üí l∆∞u v√†o history
if (msg) {
  const now = new Date();
  const time = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
  const date = now.toLocaleDateString('vi-VN');
  chat_history.push({ role: 'user', content: msg, timestamp: `${time} - ${date}` });
}

if (data.reply) {
  const now = new Date();
  const time = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
  const date = now.toLocaleDateString('vi-VN');
  chat_history.push({ role: 'assistant', content: data.reply, timestamp: `${time} - ${date}` });
}



// Reset ·∫£nh sau khi g·ª≠i
pendingImages = [];
document.getElementById('upload-input').value = '';


  // ‚úÖ Xo√° hi·ªáu ·ª©ng ‚Äúƒêang gi·∫£i...‚Äù
  const typingElem = document.getElementById('bot-typing');
  if (typingElem) typingElem.remove();
  removeOldActions();
  // ‚úÖ Hi·ªÉn th·ªã ph·∫£n h·ªìi t·ª´ AL
const botMsg = document.createElement('div');
botMsg.className = 'message bot';

// ‚úÖ X·ª≠ l√Ω xu·ªëng d√≤ng v√† in ƒë·∫≠m
let formattedReply = (data.reply || "")
  .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")  // x·ª≠ l√Ω **in ƒë·∫≠m**
  .replace(/\n/g, "<br>");                // x·ª≠ l√Ω xu·ªëng d√≤ng

botMsg.innerHTML = `

  <div class="message-text">${formattedReply}</div>
  {% if is_vip_chat %}
  <div class="message-actions" style="display: inline-flex; gap: 6px;">
    <div class="copy-container">
      <button class="copy-btn" title="Sao ch√©p n·ªôi dung" onclick="copyMessage(this)">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ffc107" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      </button>
    </div>

    <div class="emoji-container">
      <span class="emoji-btn" onclick="reactEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
      <span class="emoji-btn" onclick="reactEmoji('üòÇ')">üòÇ</span>
      <span class="emoji-btn" onclick="reactEmoji('üò¢')">üò¢</span>
      <span class="emoji-btn" onclick="reactEmoji('ü§î')">ü§î</span>
      <span class="emoji-btn" onclick="reactEmoji('üò°')">üò°</span>
    </div>
  </div>
  {% endif %}
`;

  // üëà render l·∫°i icon sau khi DOM ƒë√£ thay ƒë·ªïi




    container.appendChild(botMsg);
    container.scrollTop = container.scrollHeight;
   // C·∫£nh b√°o n·∫øu ƒëo·∫°n chat qu√° d√†i

      const userMessages = chat_history.filter(msg => msg.role === 'user').length;

      if ((userMessages >= 100 && userMessages < 300) || userMessages === 300) {
        const existing = document.getElementById("chat-warning");
        if (!existing) {
          const warn = document.createElement("div");
          warn.id = "chat-warning";
          warn.className = "chat-notice";
          warn.innerHTML = `
            ‚ö†Ô∏è B·∫°n ƒë√£ g·ª≠i h∆°n <strong>${userMessages}</strong> tin nh·∫Øn trong ƒëo·∫°n chat hi·ªán t·∫°i. <br>
            üí° ƒê·ªÉ tr√°nh lag, l·ªói hi·ªÉn th·ªã ho·∫∑c m·∫•t ƒëo·∫°n h·ªôi tho·∫°i, b·∫°n n√™n 
            <span onclick="startNewChat()">b·∫•m v√†o ƒë√¢y ƒë·ªÉ t·∫°o ƒëo·∫°n chat m·ªõi</span> nh√©!
          `;
          container.appendChild(warn);
          container.scrollTop = container.scrollHeight;
        }
      }




        
    selectedGeneralFile = null;
    document.getElementById("file-input").value = '';
    document.getElementById("file-preview").innerHTML = '';

        
    document.getElementById('image-preview').innerHTML = '';
    document.getElementById('upload-input').value = '';  // ‚Üê reset input file
    // ‚úÖ Sau khi nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi ‚Üí l∆∞u ƒëo·∫°n chat n√†y v√†o localStorage (g·ªìm c·∫£ th·ªùi gian)
    const now = Date.now();
 

    fetch("/save_chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
      messages: chat_history
    })


    });




    if (window.MathJax) MathJax.typeset();
  }

   
   

    // ‚úÖ Ch∆∞a c√≥ ·∫£nh ‚Üí x·ª≠ l√Ω b√¨nh th∆∞·ªùng
   

   
  


  document.getElementById('pdf-input').addEventListener('change', async function () {
      const file = this.files[0];
      if (!file) return;
      
      const formData = new FormData();
      formData.append('pdf', file);

      const res = await fetch('/upload_pdf', {
        method: 'POST',
        body: formData
      });

      const data = await res.json();
      addBotMessage(data.reply);
    });

</script>
<script>
  function handleKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  }
</script>

<script>
function isMathExpression(text) {
  const mathKeywords = ["ph∆∞∆°ng tr√¨nh", "t√≠nh", "gi·∫£i pt", "ƒë·∫°o h√†m", "t√≠ch ph√¢n", "lim", "cƒÉn", "b·∫≠c", "f(", "ƒë∆°n v·ªã", "cm", "mm", "gi·∫£i b√†i", "x=", "pt"];
  const nonMathPatterns = ["b·∫°n t√™n", "b·∫°n l√† ai", "ai t·∫°o", "sinh nh·∫≠t", "·ªü ƒë√¢u", "m·∫•y gi·ªù", "tr√≤ chuy·ªán", "chat", "c√≥ kh·ªèe kh√¥ng", "admin", "tr·∫£ l·ªùi","h√© l√¥","xin ch√†o"];

  const lower = text.toLowerCase();

  // N·∫øu ch·ª©a c√°c c·ª•m kh√¥ng ph·∫£i to√°n ‚Üí ch·∫Øc ch·∫Øn kh√¥ng ph·∫£i to√°n
  if (nonMathPatterns.some(p => lower.includes(p))) return false;

  // N·∫øu ch·ª©a t·ª´ to√°n h·ªçc ‚Üí nh·∫≠n l√† b√†i to√°n
  if (mathKeywords.some(k => lower.includes(k))) return true;

  // N·∫øu ch·ª©a to√°n t·ª≠ ƒë·∫∑c tr∆∞ng
  const mathRegex = /[0-9œÄ‚àö‚à´‚àë\^\+\-\*/=<>xXyYlim‚âàŒî]/i;
  return mathRegex.test(text);
}
</script>
<!-- G·ªçi th∆∞ vi·ªán icon -->
<script src="https://unpkg.com/lucide@latest"></script>

<!-- Kh·ªüi t·∫°o icon sau khi DOM s·∫µn s√†ng -->
<script>
  window.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons(); // Hi·ªÉn th·ªã c√°c bi·ªÉu t∆∞·ª£ng Lucide nh∆∞ send, mic, image...
  });

  function handlePlus() {
    alert("üìå Ch·ª©c nƒÉng b·ªï sung s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t sau!");
  }
</script>

<script>
function sendInitialMessageFromQuery() {
  const urlParams = new URLSearchParams(window.location.search);
  const msg = urlParams.get('message');
  if (!msg) return;

  const decodedMsg = decodeURIComponent(msg);
  const input = document.getElementById('chat-input');
  if (!input) return;

  input.value = decodedMsg;
  input.dispatchEvent(new Event('input'));

  const trySend = () => {
    if (typeof sendMessage === 'function') {
      sendMessage();
    } else {
      setTimeout(trySend, 100);
    }
  };

  // ‚ùó Ch·ªù to√†n b·ªô giao di·ªán load ho√†n t·∫•t
  window.addEventListener('DOMContentLoaded', () => {
    setTimeout(trySend, 500);
  });

  // Xo√° ?message ƒë·ªÉ kh√¥ng g·ª≠i l·∫°i n·∫øu reload
  const newUrl = window.location.origin + window.location.pathname;
  window.history.replaceState({}, document.title, newUrl);
}
sendInitialMessageFromQuery();
</script>




<script>
  const chatInput = document.getElementById('chat-input');
  const micBtn = document.getElementById('micBtn');
  const sendBtn = document.getElementById('send-btn');
  const emojiBox = document.getElementById('smart-emoji-suggestion');
  chatInput.addEventListener("input", () => {
    
  const text = chatInput.value.trim();
  clearTimeout(debounceTimer);

  if (text === "") {
    micBtn.style.display = "inline-block";
    sendBtn.style.display = "none";
    emojiBox.classList.add("hidden");
    allowSmartEmoji = false;

    emojiBox.innerHTML = "";
    return;
  } else {
    micBtn.style.display = "none";
    sendBtn.style.display = "inline-block";
  }

  debounceTimer = setTimeout(() => {
    fetch("/smart_emoji", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text })
    })
    .then(res => res.json())
    .then(data => {
      emojiBox.innerHTML = "";
      if (!data.emoji || data.emoji.length === 0) {
        emojiBox.classList.add("hidden");
        allowSmartEmoji = false;

        return;
      }

      data.emoji.forEach(icon => {
        const span = document.createElement("span");
        span.textContent = icon;
        span.style.cursor = "pointer";
        span.style.fontSize = "20px";
        span.style.margin = "0 5px";
        span.onclick = () => {
          chatInput.value += icon + " ";
          chatInput.focus();
        };
        emojiBox.appendChild(span);
      });

      emojiBox.classList.remove("hidden");
    });
  }, 600);
});

</script>
<script>
  const suggestionsList = [
    ["üß† Gi·∫£i ph∆∞∆°ng tr√¨nh", "üìä Ph√¢n t√≠ch d·ªØ li·ªáu", "üìù C·∫≠p nh·∫≠t k·ª≥ thi"],
    ["üìÑ Vi·∫øt ƒë∆°n xin ngh·ªâ", "üìö T√≥m t·∫Øt vƒÉn b·∫£n", "üí° ƒê·ªãnh nghƒ©a ƒë·∫°o h√†m"],
    ["üìå T·∫°o ƒë·ªÅ √¥n t·∫≠p", "üßÆ T√≠nh nhanh", "‚úçÔ∏è Vi·∫øt ƒëo·∫°n vƒÉn c·∫£m nghƒ©"],
    ["ü§ñ Tr√≤ chuy·ªán v·ªõi AI", "üìà Th·ªëng k√™ ƒëi·ªÉm", "üß¨ Gi·∫£i th√≠ch thu·∫≠t ng·ªØ"],
  ];

  function pickRandomSuggestions() {
    const idx = Math.floor(Math.random() * suggestionsList.length);
    const bar = document.getElementById("suggestions-bar");
    bar.innerHTML = '';
    suggestionsList[idx].forEach(text => {
      const tag = document.createElement("span");
      tag.innerText = text;
      tag.onclick = () => {
        document.getElementById("chat-input").value = text;
        document.getElementById("chat-input").dispatchEvent(new Event("input")); // ƒë·ªÉ k√≠ch ho·∫°t n√∫t g·ª≠i
        sendMessage(); // G·ª≠i lu√¥n
      };

      bar.appendChild(tag);
    });
  }
      window.addEventListener("DOMContentLoaded", () => {
     
    });
    // ‚úÖ N·∫øu URL c√≥ ?message=... th√¨ xo√° kh·ªèi URL sau khi g·ª≠i xong
    if (window.location.search.includes("message=")) {
      const newUrl = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, newUrl);
    }

    window.addEventListener("DOMContentLoaded", () => {
  lucide.createIcons();
  pickRandomSuggestions();
  const input = document.getElementById("chat-input");
  const sendBtn = document.getElementById("send-btn");
  const micBtn = document.getElementById("micBtn");

  if (input && input.value.trim() !== "") {
    micBtn.style.display = "none";
    sendBtn.style.display = "inline-block";
  }
  const urlParams = new URLSearchParams(window.location.search);
 

 
  const serverRenderedMessages = {{ chat_history|tojson | safe }};

  if (serverRenderedMessages && serverRenderedMessages.length > 0) {
    chat_history = [...serverRenderedMessages];
    const container = document.getElementById("chat-container");
    container.innerHTML = "";

chat_history.forEach(msg => {
  const div = document.createElement("div");
  div.className = `message ${msg.role === 'user' ? 'user' : 'bot'}`;

  // ‚úÖ X·ª≠ l√Ω ƒë·ªãnh d·∫°ng n·∫øu l√† AI tr·∫£ l·ªùi
  let content = msg.content || "";
  if (msg.role === 'assistant' || msg.role === 'bot') {
    content = content
      .replace(/\*\*(.*?)\*\*/g, "<b>$1</b>")   // in ƒë·∫≠m
      .replace(/\n/g, "<br>");                 // xu·ªëng d√≤ng
  }

  div.innerHTML = `<div class="message-text">${content}</div>`;

  // ‚úÖ N·∫øu c√≥ ·∫£nh k√®m
  if (msg.image_url) {
    const img = document.createElement("img");
    img.src = msg.image_url;
    img.className = "chat-image";
    img.style = "max-width: 360px; border-radius: 8px; margin-top: 6px;";
    div.appendChild(img);
  }

  container.appendChild(div);
});

  if (window.MathJax) {
  MathJax.typeset();  // üëâ G·ªçi l·∫°i MathJax ƒë·ªÉ render k√Ω hi·ªáu
}


    container.scrollTop = container.scrollHeight;
  }

    
    

  // ‚úÖ N·∫øu c√≥ ?message th√¨ g·ª≠i ƒëi
  const msg = urlParams.get("message");
  if (msg) {
    const decodedMsg = decodeURIComponent(msg);
    const input = document.getElementById('chat-input');
    input.value = decodedMsg;
    input.dispatchEvent(new Event('input'));

    const trySend = () => {
      if (typeof sendMessage === 'function') {
        sendMessage();
      } else {
        setTimeout(trySend, 100);
      }
    };
    setTimeout(trySend, 500);
    const newUrl = window.location.origin + window.location.pathname;
    window.history.replaceState({}, document.title, newUrl);
  }
});


    
  window.addEventListener("load", pickRandomSuggestions);

</script>
<script>
let recognition;
let isListening = false;
    function showVoiceTip() {
      const tip = document.getElementById("voice-tip");
      tip.style.display = "block";
      setTimeout(() => {
        tip.style.display = "none";
      }, 2000);
    }

function startVoiceRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert("‚ö†Ô∏è Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i.");
    return;
  }
 showVoiceTip();  // üëà Hi·ªán g·ª£i √Ω m·ªói l·∫ßn b·∫≠t mic

  recognition = new SpeechRecognition();
  recognition.lang = 'vi-VN';
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onstart = () => {
    isListening = true;
    micBtn.style.color = "#00e676";
    document.getElementById("mic-wrapper").classList.add("active");
  };
  recognition.onend = () => {
    isListening = false;
    micBtn.style.color = "white";
    document.getElementById("mic-wrapper").classList.remove("active");
  };


  recognition.onresult = (event) => {
  const transcript = event.results[0][0].transcript.trim();
  typeTextToInput(transcript, chatInput);
  const delayToSend = transcript.length * 40 + 500; // ƒë√°nh m√°y xong + 0.5s

  setTimeout(() => {
    if (chatInput.value.trim() === transcript) {
      sendMessage();
    }
  }, delayToSend);


  // T·ª± ƒë·ªông g·ª≠i n·∫øu ng∆∞·ªùi d√πng n√≥i cu·ªëi l√† t·ª´ trigger
  const lowered = transcript.toLowerCase();
  const triggers = ["g·ª≠i", "xong", "ok", "nh√©", "nha","nh√≥","nh·ªâ", "ƒë∆∞·ª£c kh√¥ng"];
  const endsWithTrigger = triggers.some(trigger => lowered.endsWith(trigger));

  if (endsWithTrigger) {
    setTimeout(() => {
      // N·∫øu ng∆∞·ªùi d√πng ch∆∞a s·ª≠a n·ªôi dung trong 1.5s
      if (chatInput.value.trim() === transcript) {
        console.log("ü§ñ Auto g·ª≠i v√¨ k·∫øt th√∫c b·∫±ng t·ª´ trigger.");
        sendMessage(); // ‚úÖ G·ª≠i t·ª± ƒë·ªông
      }
    }, 1500);
  } else {
    console.log("‚úã ƒê√£ nh·∫≠n vƒÉn b·∫£n, ch·ªù ng∆∞·ªùi d√πng b·∫•m g·ª≠i.");
  }
};


  recognition.start();
}
function togglePlusMenu() {
  const menu = document.getElementById("plus-menu");
  const icon = document.getElementById("plus-icon");

  const isVisible = menu.style.display === "block";
  menu.style.display = isVisible ? "none" : "block";

  // ‚ú® G·∫Øn hi·ªáu ·ª©ng ph·ªìng + s√°ng
  icon.classList.add("plus-icon-flash");
  setTimeout(() => {
    icon.classList.remove("plus-icon-flash");
  }, 400);
}


// Auto t·∫Øt menu n·∫øu click ngo√†i
document.addEventListener("click", function (event) {
  const menu = document.getElementById("plus-menu");
  const plusContainer = document.querySelector(".plus-container");
  if (!plusContainer.contains(event.target)) {
    menu.style.display = "none";
  }
});

</script>
<script>
function handleGeneralFile(event) {
  const file = event.target.files[0];
  if (!file) return;

  const container = document.getElementById("chat-container");

  // Hi·ªÉn th·ªã file l√™n giao di·ªán
  const userMsg = document.createElement("div");
  userMsg.className = "message user";
  const link = document.createElement("a");
  link.href = URL.createObjectURL(file);
  link.download = file.name;
  link.innerText = `üìé ${file.name}`;
  link.style.color = "#00bcd4";
  link.style.textDecoration = "underline";
  userMsg.appendChild(link);
  container.appendChild(userMsg);
  container.scrollTop = container.scrollHeight;

  // G·ª≠i file l√™n server
  const formData = new FormData();
  formData.append("file", file);

  fetch("/upload_file", {
  method: "POST",
  body: formData
}).then(res => res.json())
 .then(data => {
  const botMsg = document.createElement("div");
  botMsg.className = "message bot";
  botMsg.innerHTML = data.reply ? data.reply : "‚úÖ ƒê√£ g·ª≠i file th√†nh c√¥ng!";
  container.appendChild(botMsg);
  container.scrollTop = container.scrollHeight;

  // ‚úÖ G·ªçi l·∫°i MathJax ƒë·ªÉ render c√¥ng th·ª©c
  if (window.MathJax) MathJax.typeset();
})
.catch(err => {
  const botMsg = document.createElement("div");
  botMsg.className = "message bot";
  botMsg.innerText = "‚ùå C√≥ l·ªói khi g·ª≠i file.";
  container.appendChild(botMsg);
});

}
function shareLocation() {
  if (!navigator.geolocation) {
    alert("‚ö†Ô∏è Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ l·∫•y v·ªã tr√≠.");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    (position) => {
      const { latitude, longitude } = position.coords;
      const container = document.getElementById("chat-container");

      const msg = document.createElement("div");
      msg.className = "message user";
      msg.innerHTML = `
        üìç <b>V·ªã tr√≠ c·ªßa t√¥i:</b><br>
        Kinh ƒë·ªô: <code>${longitude.toFixed(6)}</code><br>
        Vƒ© ƒë·ªô: <code>${latitude.toFixed(6)}</code><br>
        <a href="https://www.google.com/maps?q=${latitude},${longitude}" target="_blank" style="color:#00bcd4">
          üìå Xem tr√™n Google Maps
        </a>
      `;
      container.appendChild(msg);
      container.scrollTop = container.scrollHeight;

      // (Tu·ª≥ ch·ªçn) G·ª≠i v·ªã tr√≠ n√†y l√™n server n·∫øu c·∫ßn:
      /*
      fetch("/receive_location", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ lat: latitude, lng: longitude })
      });
      */
    },
    (error) => {
      alert("‚ùå Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠. B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn ho·∫∑c c√≥ l·ªói.");
    }
  );
}
function sendGeneralFile() {
  if (!selectedGeneralFile) return;

  const container = document.getElementById("chat-container");

  // Hi·ªÉn th·ªã file nh∆∞ tin nh·∫Øn user
  const userMsg = document.createElement("div");
  userMsg.className = "message user";

  const link = document.createElement("a");
  link.href = URL.createObjectURL(selectedGeneralFile);
  link.download = selectedGeneralFile.name;
  link.innerText = `üìé ${selectedGeneralFile.name}`;
  link.style.color = "#00bcd4";
  link.style.textDecoration = "underline";

  userMsg.appendChild(link);
  container.appendChild(userMsg);
  container.scrollTop = container.scrollHeight;

  // G·ª≠i l√™n server
  const formData = new FormData();
  formData.append("file", selectedGeneralFile);

  fetch("/upload_file", {
    method: "POST",
    body: formData
  }).then(res => res.json())
    .then(data => {
      const botMsg = document.createElement("div");
      botMsg.className = "message bot";
      botMsg.innerHTML = data.reply || "‚úÖ ƒê√£ g·ª≠i file th√†nh c√¥ng!";
      container.appendChild(botMsg);
      container.scrollTop = container.scrollHeight;

      if (window.MathJax) MathJax.typeset();
    });

  // Reset
  selectedGeneralFile = null;
  document.getElementById("file-input").value = '';
  document.getElementById("file-preview").innerHTML = '';
}

let selectedGeneralFile = null;

function previewGeneralFile(event) {
  const file = event.target.files[0];
  if (!file) return;

  selectedGeneralFile = file;

  const preview = document.getElementById("file-preview");
  preview.innerHTML = `
    <div style="position: relative; display: inline-block; margin: 6px;">
      <div style="padding: 8px 12px; background: #333; color: #00bcd4; border-radius: 8px; font-size: 14px; max-width: 280px;">
        üìé ${file.name}
      </div>
      <button onclick="removeGeneralFile()" style="position: absolute; top: -6px; right: -6px; background: #e53935; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer;">√ó</button>
    </div>
  `;
}
 
function openAlbum() {
  fetch("/get_user_album")
    .then(res => res.json())
    .then(data => {
      const albumHTML = data.images.map(img => `
      <div style="margin: 6px; display: inline-block;">
        <img src="${img.path}" style="max-width: 120px; border-radius: 6px; cursor: pointer;" onclick="openImagePopup('${img.path}')" />
      </div>
    `).join("");


      const overlay = document.createElement("div");
      overlay.innerHTML = `
        <div style="position:fixed; top:0; left:0; right:0; bottom:0; background:#000a; z-index:9999; display:flex; justify-content:center; align-items:center;">
          <div style="background:#222; padding:20px; border-radius:10px; max-width:90%; max-height:90%; overflow:auto;">
            <h3 style="color:#00bcd4">üì∏ Album ·∫£nh ƒë√£ g·ª≠i (l∆∞u trong 7 ng√†y)</h3>
            ${albumHTML || "<p style='color:white'>Ch∆∞a c√≥ ·∫£nh n√†o.</p>"}
            <div style="text-align:right; margin-top:12px;">
              <button onclick="this.closest('div[style^=position]').remove()" style="padding: 6px 14px; border-radius:6px; background:#e53935; color:white; border:none;">ƒê√≥ng</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
    });
}
function openImagePopup(src) {
  const popup = document.getElementById("image-popup");
  const img = document.getElementById("popup-img");
  img.src = src;
  popup.style.display = "flex";
}

function closeImagePopup() {
  document.getElementById("image-popup").style.display = "none";
}
function typeTextToInput(text, inputElement, speed = 40) {
  inputElement.value = ""; // xo√° tr∆∞·ªõc
  let index = 0;

  function typeNextChar() {
    if (index < text.length) {
      inputElement.value += text.charAt(index);
      index++;
      setTimeout(typeNextChar, speed);
    }
  }

  typeNextChar();
}

</script>
<!-- üîç Popup hi·ªÉn th·ªã ·∫£nh to -->
<div id="image-popup" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); z-index:99999; justify-content:center; align-items:center;">
  <span onclick="closeImagePopup()" style="position:absolute; top:20px; right:30px; font-size:32px; color:white; cursor:pointer;">&times;</span>
  <img id="popup-img" src="" style="max-width:90%; max-height:90%; border-radius:12px;" />
</div>
<div id="voice-tip" style="position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: none; z-index: 9999;">
  üëâ B·∫°n c√≥ th·ªÉ n√≥i: <b>g·ª≠i</b>, <b>xong</b>, <b>ok</b>, <b>nh√©</b>, <b>nha</b>, <b>ƒë∆∞·ª£c kh√¥ng</b>
</div>
<script>
function startNewChat() {
  // ‚ùå Xo√° c·∫£nh b√°o n·∫øu c√≥ (v√≠ d·ª•: c·∫£nh b√°o x√°c th·ª±c)
  const oldWarn = document.getElementById("chat-warning");
  if (oldWarn) oldWarn.remove();

  // üõ† G·ªçi route xo√° ƒëo·∫°n chat tr√™n server
  fetch("/new_chat", { method: "POST" })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        // ‚úÖ Reset giao di·ªán chat
        chat_history = [];

        const container = document.getElementById("chat-container");
        container.innerHTML = "";

        // ‚úÖ Xo√° preview ·∫£nh & file
        const imgPreview = document.getElementById("image-preview");
        const filePreview = document.getElementById("file-preview");
        const fileInput = document.getElementById("file-input");
        const uploadInput = document.getElementById("upload-input");

        if (imgPreview) imgPreview.innerHTML = "";
        if (filePreview) filePreview.innerHTML = "";
        if (fileInput) fileInput.value = "";
        if (uploadInput) uploadInput.value = "";

        // ‚úÖ Cu·ªôn v·ªÅ ƒë·∫ßu
        container.scrollTop = 0;

        // ‚úÖ Reload l·∫°i trang ƒë·ªÉ ƒë·∫£m b·∫£o s·∫°ch s·∫Ω m·ªçi th·ª©
        location.reload();
      } else {
        console.error("‚ùå L·ªói khi t·∫°o ƒëo·∫°n chat m·ªõi:", data.error || "Kh√¥ng r√µ nguy√™n nh√¢n");
        alert("‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫°o ƒëo·∫°n chat m·ªõi. Vui l√≤ng th·ª≠ l·∫°i.");
      }
    })
    .catch(err => {
      console.error("‚ùå L·ªói k·∫øt n·ªëi khi t·∫°o ƒëo·∫°n chat m·ªõi:", err);
      alert("‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i.");
    });
}



</script>
<div id="image-viewer" class="image-viewer-overlay" onclick="this.style.display='none'">
  <img src="" id="image-viewer-img">
</div>

<script>
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('chat-image')) {
      const viewer = document.getElementById("image-viewer");
      const viewerImg = document.getElementById("image-viewer-img");
      viewerImg.src = e.target.src;
      viewer.style.display = "flex";
    }
  });
function copyMessage(btn) {
  const message = btn.closest('.message').querySelector('.message-text').innerText;
  navigator.clipboard.writeText(message).then(() => {
    const toast = document.getElementById("copy-toast");
    toast.style.display = "block";

    // Reset animation ƒë·ªÉ n√≥ lu√¥n ph√°t l·∫°i t·ª´ ƒë·∫ßu
    toast.classList.remove("showing");
    void toast.offsetWidth; // Force reflow
    toast.classList.add("showing");

    setTimeout(() => {
      toast.style.display = "none";
    }, 1800);
  });
}



function reactEmoji(emoji) {
  const container = document.getElementById("chat-container");
  const latestBotMsg = document.querySelector('.message.bot:last-of-type');
  if (latestBotMsg) {
    const emojiBar = latestBotMsg.querySelector(".emoji-container");
    const copyBtn = latestBotMsg.querySelector(".copy-container");
    if (emojiBar) emojiBar.style.display = "none";
    if (copyBtn) copyBtn.style.display = "inline-flex";  // hi·ªÉn th·ªã l·∫°i n√∫t copy n·∫øu c·∫ßn
  }

  // üß† T√¨m c√¢u tr·∫£ l·ªùi cu·ªëi c√πng t·ª´ AI
  const lastReply = document.querySelector('.message.bot:last-of-type .message-text')?.innerText || "";
    if (lastReply.includes("B·∫°n ƒë√£ d√πng h·∫øt") && lastReply.includes("GPT h√¥m nay")) {

    console.log("üö´ ƒê√£ v∆∞·ª£t gi·ªõi h·∫°n, kh√¥ng ph·∫£n h·ªìi emoji.");
    return;
  }

  // ‚úÖ Th√™m hi·ªáu ·ª©ng emoji bay l√™n
  const fly = document.createElement("div");
  fly.className = "flying-emoji";
  fly.innerText = emoji;
  document.body.appendChild(fly);
  const mouseX = window.event?.clientX || window.innerWidth / 2;
  const mouseY = window.event?.clientY || window.innerHeight / 2;
  fly.style.left = mouseX + "px";
  fly.style.top = mouseY + "px";
  setTimeout(() => fly.remove(), 1000);

  // ‚úÖ Hi·ªÉn th·ªã "ƒêang ph·∫£n h·ªìi..."
  const loadingDiv = document.createElement("div");
  loadingDiv.className = "message bot";
  loadingDiv.id = "emoji-loading";
  loadingDiv.innerHTML = `
    <span style="color:gray; font-style: italic">
      ƒêang tr·∫£ l·ªùi<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>
    </span>
  `;
  container.appendChild(loadingDiv);
  container.scrollTop = container.scrollHeight;

  // ‚è±Ô∏è G·ª≠i y√™u c·∫ßu ƒë·∫øn Flask k√®m c·∫£ c·∫£m x√∫c + c√¢u v·ª´a tr·∫£ l·ªùi
  setTimeout(() => {
    fetch('/send-emoji', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        emoji: emoji,
        last_reply: lastReply,
        history: chat_history  // ‚úÖ G·ª≠i c·∫£ l·ªãch s·ª≠ n·∫øu mu·ªën AI ti·∫øp m·∫°ch
      })
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById("emoji-loading")?.remove();

      const replyDiv = document.createElement("div");
      replyDiv.className = "message bot";
      replyDiv.innerHTML = `<div class="message-text">${data.ai_reply}</div>`;
      container.appendChild(replyDiv);
      container.scrollTop = container.scrollHeight;

      // ‚úÖ L∆∞u ph·∫£n h·ªìi c·∫£m x√∫c nh∆∞ 1 ph·∫ßn c·ªßa ƒëo·∫°n chat
      chat_history.push({ role: 'assistant', content: data.ai_reply });
    });
  }, 1200);
}


</script>

<!-- üéâ Toast th√¥ng b√°o copy -->
<!-- ‚úÖ Ch·ªâ gi·ªØ duy nh·∫•t 1 th·∫ª n√†y trong to√†n b·ªô HTML -->
<div id="copy-toast">
  ‚úÖ ƒê√£ sao ch√©p n·ªôi dung!
</div>

<style>
/* ‚úÖ Hi·ªáu ·ª©ng m∆∞·ª£t v√† kh√¥ng xung ƒë·ªôt */
@keyframes slideFadeUp {
  0% {
    opacity: 0;
    transform: translateY(30px);
  }
  20% {
    opacity: 1;
    transform: translateY(0);
  }
  80% {
    opacity: 1;
    transform: translateY(0);
  }
  100% {
    opacity: 0;
    transform: translateY(-10px);
  }
}

#copy-toast {
  position: fixed;
  bottom: 95px; /* üëà ƒë·∫©y cao h∆°n 1 ch√∫t ƒë·ªÉ kh√¥ng ƒë√® v√†o khung nh·∫≠p */
  left: 50%;
  transform: translateX(-50%);
  background-color: #00c4ff;
  color: white;
  padding: 10px 18px; 
  border-radius: 8px;  
  font-size: 14px;
  font-weight: 500;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
  z-index: 9999;
  display: none;
  white-space: nowrap;
  animation: slideFadeUp 1.8s ease-in-out;
  pointer-events: none;
}
</style>


<style>
@keyframes toastVerifiedFade {
  0% { opacity: 0; transform: translateY(-10px); }
  10% { opacity: 1; transform: translateY(0); }
  90% { opacity: 1; transform: translateY(0); }
  100% { opacity: 0; transform: translateY(-10px); }
}
</style>
<div id="toast-verified" style="display:none; position:fixed; bottom:30px; left:50%; transform:translateX(-50%);
  background-color:#1e1e1e; color:#00e676; padding:12px 20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.3);
  font-weight:500; z-index:9999; animation:toastVerifiedFade 4s ease-in-out;">
  ‚úÖ T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ x√°c th·ª±c t·ª´ tr∆∞·ªõc r·ªìi!
</div>


<style>
@keyframes fadeInOut {
  0% { opacity: 0; bottom: 0px; }
  10% { opacity: 1; bottom: 30px; }
  90% { opacity: 1; bottom: 30px; }
  100% { opacity: 0; bottom: 0px; }
}
</style>

{% if session.get("just_verified_already") %}
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const toast = document.getElementById("toast-verified");
    if (toast) toast.style.display = "block";
  });
</script>
{% endif %}

<script>
  const uploadBtn = document.getElementById("upload-btn");
  uploadBtn.addEventListener("click", function () {
    uploadBtn.classList.add("effect");
    setTimeout(() => uploadBtn.classList.remove("effect"), 300);
  });
</script>


<script>
function showVipWarning() {
  document.getElementById("vip-overlay").style.display = "block";
  const popup = document.getElementById("vip-warning");
  popup.style.display = "block";
  setTimeout(() => {
    popup.style.transform = "translate(-50%, -50%) scale(1)";
  }, 10);
}

function hideVipWarning() {
  const popup = document.getElementById("vip-warning");
  popup.style.transform = "translate(-50%, -50%) scale(0.95)";
  setTimeout(() => {
    popup.style.display = "none";
    document.getElementById("vip-overlay").style.display = "none";
  }, 200);
}
</script>
{% if is_maintenance %}
  <style>
    .overlay-maintenance {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.92);
      z-index: 999999;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
      font-family: sans-serif;
      text-align: center;
      pointer-events: all;
    }

    .overlay-maintenance h2 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    .overlay-maintenance p {
      font-size: 1rem;
      color: #ccc;
    }
  </style>

  <div class="overlay-maintenance" id="maintenance-overlay">
    <h2>üöß H·ªá th·ªëng ƒëang b·∫£o tr√¨</h2>
    <p>SolverViet hi·ªán ƒëang n√¢ng c·∫•p ƒë·ªÉ ph·ª•c v·ª• t·ªët h∆°n.<br>Vui l√≤ng quay l·∫°i sau!</p>
  </div>
{% endif %}

<script>
  setInterval(() => {
    fetch("/check_maintenance?feature=gpt_chat")
      .then(res => res.json())
      .then(data => {
        const existing = document.getElementById("maintenance-overlay");

        if (data.maintenance) {
          if (!existing) {
            const overlay = document.createElement("div");
            overlay.id = "maintenance-overlay";
            overlay.style.position = "fixed";
            overlay.style.inset = "0";
            overlay.style.zIndex = "999999";
            overlay.style.backgroundColor = "rgba(0,0,0,0.92)";
            overlay.style.display = "flex";
            overlay.style.flexDirection = "column";
            overlay.style.alignItems = "center";
            overlay.style.justifyContent = "center";
            overlay.style.color = "white";
            overlay.style.fontFamily = "sans-serif";
            overlay.innerHTML = `
              <div style="background:white; color:black; padding:24px; border-radius:12px; max-width:400px; text-align:center; box-shadow:0 0 20px rgba(0,0,0,0.4);">
                <h2 style="font-size: 1.75rem; margin-bottom: 0.5rem;">üöß H·ªá th·ªëng ƒëang b·∫£o tr√¨</h2>
                <p>SolverViet hi·ªán ƒëang n√¢ng c·∫•p h·ªá th·ªëng.<br>Vui l√≤ng quay l·∫°i sau!</p>
              </div>
            `;
            document.body.appendChild(overlay);
          }
        } else {
          if (existing) {
            existing.remove(); // ‚úÖ G·ª° overlay khi admin ƒë√£ t·∫Øt b·∫£o tr√¨
          }
        }
      });
  }, 5000); // Ki·ªÉm tra m·ªói 5s

</script>
<script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>

<script>
function toggleEmojiPicker() {
  const emojiPopup = document.getElementById("emojiPopup");
  emojiPopup.style.display = emojiPopup.style.display === "none" ? "block" : "none";
}

document.addEventListener("DOMContentLoaded", () => {
  const emojiPicker = document.querySelector("emoji-picker");
  const messageInput = document.getElementById("chat-input");
  emojiPicker.addEventListener("emoji-click", event => {
    messageInput.value += event.detail.unicode;
    emojiPopup.style.display = "none";
  });
});
function toggleTheme() {
  const body = document.body;
  const icon = document.getElementById("theme-icon");
  const isDark = body.classList.contains("dark");

  if (isDark) {
    body.classList.remove("dark");
    localStorage.setItem("theme", "light");

    // ƒë·ªïi v·ªÅ m·∫∑t tr·ªùi ‚òÄ
    icon.innerHTML = `
      <circle cx="12" cy="12" r="5"/>
      <line x1="12" y1="1" x2="12" y2="3"/>
      <line x1="12" y1="21" x2="12" y2="23"/>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
      <line x1="1" y1="12" x2="3" y2="12"/>
      <line x1="21" y1="12" x2="23" y2="12"/>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
    `;
  } else {
    body.classList.add("dark");
    localStorage.setItem("theme", "dark");

    // ƒë·ªïi sang m·∫∑t trƒÉng üåô
    icon.innerHTML = `
      <path d="M21 12.79A9 9 0 1 1 11.21 3
        7 7 0 0 0 21 12.79z"/>
    `;
  }
}
document.addEventListener("DOMContentLoaded", () => {
  const saved = localStorage.getItem("theme");
  if (saved === "dark") {
    document.body.classList.add("dark");
    toggleTheme(); // g·ªçi 1 l·∫ßn ƒë·ªÉ update icon
  }
});
document.addEventListener("DOMContentLoaded", () => {
  const savedTheme = localStorage.getItem("theme");

  if (savedTheme === "dark") {
    document.body.classList.add("dark");

    // N·∫øu b·∫°n c√≥ bi·ªÉu t∆∞·ª£ng m·∫∑t tr·ªùi/m·∫∑t trƒÉng, c·∫≠p nh·∫≠t l·∫°i lu√¥n:
    const icon = document.getElementById("theme-icon");
    if (icon) {
      icon.innerHTML = `
        <path d="M21 12.79A9 9 0 1 1 11.21 3
          7 7 0 0 0 21 12.79z"/>
      `;
    }
  }
});

</script>
<script>
window.addEventListener("DOMContentLoaded", () => {
  const chatInput = document.getElementById("chat-input");
  const micBtn = document.getElementById("micBtn");
  const sendBtn = document.getElementById("send-btn");
  const emojiBox = document.getElementById("smart-emoji-suggestion");
  let debounceTimer;

  chatInput.addEventListener("input", () => {
    const text = chatInput.value.trim();
    clearTimeout(debounceTimer);

    if (text === "") {
      micBtn.style.display = "inline-block";
      sendBtn.style.display = "none";
      emojiBox.classList.add("hidden");
      allowSmartEmoji = false;

      emojiBox.innerHTML = "";
      return;
    } else {
      micBtn.style.display = "none";
      sendBtn.style.display = "inline-block";
    }

    debounceTimer = setTimeout(() => {
      fetch("/smart_emoji", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text })
      })
      .then(res => res.json())
      .then(data => {
        emojiBox.innerHTML = "";
        if (!data.emoji || data.emoji.length === 0) {
          emojiBox.classList.add("hidden");
          allowSmartEmoji = false;

          return;
        }

        data.emoji.forEach(icon => {
          const span = document.createElement("span");
          span.textContent = icon;
          span.style.cursor = "pointer";
          span.style.fontSize = "20px";
          span.style.margin = "0 5px";
          span.onclick = () => {
            chatInput.value += icon + " ";
            chatInput.focus();
          };
          emojiBox.appendChild(span);
        });

        emojiBox.classList.remove("hidden");
      });
    }, 600);
  });
});
document.addEventListener("dragover", function (e) {
  e.preventDefault(); // Cho ph√©p k√©o v√†o
});

document.addEventListener("drop", function (e) {
  e.preventDefault();

  const files = e.dataTransfer.files;
  if (files.length > 0) {
    const input = document.getElementById("upload-input");

    // T·∫°o s·ª± ki·ªán gi·∫£ ƒë·ªÉ truy·ªÅn files v√†o input
    const dataTransfer = new DataTransfer();
    for (let i = 0; i < files.length; i++) {
      if (files[i].type.startsWith("image/")) {
        dataTransfer.items.add(files[i]);
      }
    }

    input.files = dataTransfer.files;

    // G·ªçi s·ª± ki·ªán onchange (t√°i s·ª≠ d·ª•ng logic c≈©)
    input.dispatchEvent(new Event('change'));
  }
});

</script>

</body>
</html>
