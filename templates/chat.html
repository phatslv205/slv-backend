<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>Chat - SolverViet</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"><link rel="icon" type="image/png" href="{{ url_for('static', filename='logos/favicon.png') }}"><script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/index.min.js"></script><script src="https://unpkg.com/lucide@latest"></script>
<style>body{margin:0;padding:0;font-family:'Segoe UI',sans-serif;background-color:#f7f9fc;color:#333;height:100vh;display:flex;flex-direction:column;}.chat-header{padding:12px 20px;background-color:#fff;border-bottom:1px solid #ddd;display:flex;justify-content:space-between;align-items:center;}.chat-body{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;}.chat-footer{padding:10px 20px;background-color:#fff;border-top:1px solid #ddd;display:flex;gap:10px;align-items:center;}.message{max-width:72%;margin-bottom:6px;padding:8px 12px;border-radius:12px;font-size:0.95rem;line-height:1.4;position:relative;word-break:break-word;transition:background-color 0.2s;}.message.me{align-self:flex-end;background-color:#005fff;color:white;}.message.friend{align-self:flex-start;background-color:#e5e5ea;color:#000;}.message:hover{background-color:#dcdcdc;}.message-time{font-size:0.7rem;color:#aaa;margin-top:2px;text-align:right;display:none;}.message:hover .message-time{display:block;}.input-box{flex:1;border:1px solid #ccc;border-radius:999px;padding:12px 18px;font-size:0.95rem;height:42px;outline:none;}.input-box:focus{border-color:#00aaff;}.icon-btn{background:none;border:none;font-size:1.25rem;color:#007bff;cursor:pointer;transition:transform 0.15s ease;}.icon-btn:hover{transform:scale(1.1);}.icon-btn:active{transform:scale(0.85);}.preview-img{max-width:120px;max-height:120px;border-radius:10px;margin-right:10px;margin-top:5px;object-fit:cover;cursor:zoom-in;}.reaction-bar{display:none;gap:6px;margin-top:6px;padding:4px 6px;background-color:rgba(0,0,0,0.1);border-radius:999px;width:fit-content;}.message:hover .reaction-bar{display:flex;}.reaction-btn{cursor:pointer;font-size:18px;transition:transform 0.2s;}.reaction-btn:hover{transform:scale(1.4);}.reacted-red{background-color:#ffe6e6!important;}.reacted-yellow{background-color:#fff8d1!important;}.reacted-blue{background-color:#d1ecff!important;}.reacted-purple{background-color:#f3e6ff!important;}.reacted-orange{background-color:#ffe2cc!important;}.system-message{background-color:#ffecec;color:#d10000;text-align:center;padding:10px 16px;margin:12px auto;border-radius:8px;font-size:0.95rem;max-width:80%;box-shadow:0 0 5px rgba(0,0,0,0.1);}.reply-box{background:#eef5ff;border-left:3px solid #00aaff;padding:8px 12px;border-radius:10px;margin-bottom:10px;font-size:0.9rem;}.emoji-picker{z-index:99999!important;}.flying-emoji{position:fixed;font-size:24px;pointer-events:none;animation:flyUpFade 1s ease forwards;user-select:none;z-index:100000;}@keyframes flyUpFade{0%{transform:translateY(0) scale(1);opacity:1;}100%{transform:translateY(-100px) scale(1.5);opacity:0;}}#chat-settings-popup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.6);z-index:9999;justify-content:center;align-items:center;}.chat-header a.btn,.chat-header button.btn{border-radius:8px;font-weight:600;font-size:0.9rem;padding:6px 14px;transition:all 0.3s ease;color:#333!important;background-color:#f1f1f1;border:1px solid #ccc;}.chat-header a.btn:hover,.chat-header button.btn:hover{background-color:#e6e6e6;color:#000!important;border-color:#bbb;}#voice-btn:hover{background-color:#ddd;cursor:pointer;}#voice-btn.recording{background-color:#ff4d4f!important;animation:pulseGlow 1.2s infinite;box-shadow:0 0 0 0 rgba(255,77,79,0.7);}@keyframes pulseGlow{0%{box-shadow:0 0 0 0 rgba(255,77,79,0.7);}70%{box-shadow:0 0 0 10px rgba(255,77,79,0);}100%{box-shadow:0 0 0 0 rgba(255,77,79,0);}}.preview-img-wrapper { position: relative;display: inline-block;}.preview-img-wrapper span {position: absolute;top: -6px;right: -6px;background: white;color: red;font-weight: bold;border: 1px solid #ccc;border-radius: 50%;padding: 0 5px;cursor: pointer;font-size: 13px;}</style></head>
<body>
<div class="chat-header">
<div style="display: flex; align-items: center; gap: 16px;">
<div style="display: flex; flex-direction: column;">
<strong id="friend-name">
{{ friend.fullname if friend.fullname else friend.name if friend.name else friend_username }}
</strong>
<span style="font-size: 0.8rem; color: {{ 'green' if 'ƒêang ho·∫°t ƒë·ªông' in friend_status else '#888' }};">
{{ friend_status }}
</span>
</div>
<div style="display: flex; gap: 6px;">
<button id="chat-settings-btn" class="btn btn-sm btn-light" title="C√†i ƒë·∫∑t ƒëo·∫°n chat">
<i class="bi bi-gear-fill"></i>
</button>
</div>
</div>
<div>
<button type="button" onclick="openAlbumModal()" class="btn btn-sm btn-light"> Album ·∫£nh</button>
<a href="/friends" class="btn btn-sm btn-light me-2">‚Üê Quay l·∫°i</a>
</div>
</div>
<div class="chat-body" id="chat-body">
  {% for msg in messages %}
      <div class="message {% if msg.sender == username %}me{% else %}friend{% endif %} chat-bubble" 
              id="msg-{{ msg.id }}" 
              data-msg-id="{{ msg.id }}"
              data-sender="{{ msg.sender }}"
              data-fullname="{% if msg.sender == username %}{{ current_user.fullname }}{% else %}{{ friend.fullname }}{% endif %}">
      {% if msg.unsent %}
        <i style="color:gray;">
          {% if msg.sender == username %}
            You have recalled a message.
          {% else %}
            The message has been recalled.
          {% endif %}
        </i>
      {% else %}
        {% if msg.image_urls %}
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            {% for img in msg.image_urls %}
              <img src="{{ img }}?v={{ loop.index0 }}"
                   class="preview-img"
                   loading="lazy"
                   onclick="showImageModal(this.src)"
                   onerror="this.style.display='none';">
            {% endfor %}
          </div>
        {% endif %}
        {% if msg.reply_to %}
        <div class="reply-box" data-reply-sender="{{ msg.reply_to.sender }}">
          {% set reply_text = msg.reply_to.text %}
          {% if reply_text == "Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi." %}
            <i style="color: #888;">(ƒë√£ thu h·ªìi)</i>
          {% elif reply_text == "Tin nh·∫Øn kh√¥ng t·ªìn t·∫°i." %}
            <i style="color: #888;">(kh√¥ng t·ªìn t·∫°i)</i>
          {% elif reply_text %}
            {% set reply_name = msg.reply_to.fullname if msg.reply_to.fullname else msg.reply_to.sender %}
            Tr·∫£ l·ªùi <strong class="reply-name">{{ reply_name }}</strong>:
          {% else %}
            <i style="color: #888;">(kh√¥ng r√µ n·ªôi dung)</i>
          {% endif %}
        </div>
      {% endif %}
        {% if msg.text %}
          <div class="message-text">{{ msg.text }}</div>
        {% endif %}
        {% if msg.voice_url %}
          <audio controls style="margin-top: 5px; max-width: 250px;">
            <source src="{{ msg.voice_url }}" type="audio/webm">
            Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ audio.
          </audio>
        {% endif %}
     {% if msg.video_url %}
        <video controls style="margin-top: 5px; max-width: 300px;" preload="metadata">
          <source src="{{ msg.video_url }}" type="video/mp4">
          Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ video.
        </video>
      {% endif %}
        <div class="message-time">{{ msg.time }}</div>
        {% if msg.days_left %}
          <div class="text-danger mt-1" style="font-size: 0.75rem;">
            ‚ö†Ô∏è Tin nh·∫Øn n√†y v√† ·∫£nh s·∫Ω t·ª± ƒë·ªông b·ªã xo√° sau {{ msg.days_left }} ng√†y n·ªØa.
          </div>
        {% endif %}
      {% endif %}
{% if msg.sender != username %}
  <div class="reaction-bar mt-1">
    <span class="reaction-btn" onclick="react('{{ msg.id }}', '‚ù§Ô∏è')">‚ù§Ô∏è</span>
    <span class="reaction-btn" onclick="react('{{ msg.id }}', 'üòÇ')">üòÇ</span>
    <span class="reaction-btn" onclick="react('{{ msg.id }}', 'üò¢')">üò¢</span>
    <span class="reaction-btn" onclick="react('{{ msg.id }}', 'ü§î')">ü§î</span>
    <span class="reaction-btn" onclick="react('{{ msg.id }}', 'üò°')">üò°</span>
  </div>
{% endif %}
</div>
{% endfor %}
</div>
<div id="video-preview-wrapper" style="margin-left: 10px; margin-top: 8px;"><video id="preview-video" style="max-width: 200px; display: none;" controls><source id="preview-video-source" src="">Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ video.</video></div>
<div id="preview-container" class="px-3 pb-2" style="display: none;"></div>
<form id="chat-form" enctype="multipart/form-data" class="chat-footer" style="display:flex; align-items:center; gap:8px; padding:10px 14px; background:#111; border-top:1px solid #222;"><button type="button" id="voice-btn" class="icon-btn" style="padding:8px;"><i data-lucide="mic" style="width:20px; height:20px;"></i></button><input type="text" id="chat-input" name="text" class="input-box" placeholder="Nh·∫≠p tin nh·∫Øn..." style="flex:1; border-radius:999px; background:#2b2b2b; color:#eee; border:none; padding:10px 16px; font-size:15px;"><button type="button" id="emoji-btn" class="icon-btn" title="Emoji"><i data-lucide="smile" style="width:20px; height:20px;"></i></button><button type="submit" class="icon-btn" title="G·ª≠i tin nh·∫Øn"><i data-lucide="send" style="width:20px; height:20px;"></i></button><label class="icon-btn" title="G·ª≠i ·∫£nh"><i data-lucide="image" style="width:20px; height:20px;"></i><input type="file" name="images" multiple accept="image/*" onchange="previewMultiple(this)" hidden></label><label class="icon-btn" title="G·ª≠i video"><i data-lucide="video" style="width:20px; height:20px;"></i><input type="file" name="video" accept="video/*" onchange="handleVideoPreview(this)" hidden></label></form>
<div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:9999;"><span onclick="closeImageModal()" style="position:absolute; top:20px; right:30px; color:white; font-size:30px; cursor:pointer;">&times;</span><img id="modalImage" src="" style="max-width:90%; max-height:90%; border-radius:10px;"></div>
<script>
  window.addEventListener('load', function() {
  const friendUsername = '{{ friend_username }}'; 
  let nameEl = document.getElementById('friend-name');
  const editBtn = document.getElementById('edit-name-btn');
  const savedName = localStorage.getItem('friend_name_' + friendUsername);
if (friendName === friendUsername) {
  localStorage.removeItem('friend_name_' + friendUsername);
} else if (savedName) {
  nameEl.textContent = savedName;
}
  editBtn.addEventListener('click', () => {
    const currentName = nameEl.textContent;
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentName;
    input.className = 'form-control form-control-sm d-inline-block';
    input.style.width = 'auto';
    nameEl.replaceWith(input);
    input.focus();
    function save() {
      const newName = input.value.trim() || currentName;
      localStorage.setItem('friend_name_' + friendUsername, newName);
      const newSpan = document.createElement('strong');
      newSpan.id = 'friend-name';
      newSpan.textContent = newName;
      input.replaceWith(newSpan);
      nameEl = newSpan;
    }
    input.addEventListener('blur', save);
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        save();
      }
    });
  });
});
    let totalFiles = [];
    function previewMultiple(input) {
      const container = document.getElementById("preview-container");
      const newFiles = Array.from(input.files);
      totalFiles = totalFiles.concat(newFiles);
      if (totalFiles.length > 5) {
        alert(" T·ªëi ƒëa 5 ·∫£nh!");
        totalFiles = totalFiles.slice(0, 5);
      }
      container.innerHTML = "";
      container.style.display = "flex";
      totalFiles.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const wrapper = document.createElement("div");
            wrapper.style.position = "relative";
            wrapper.style.display = "inline-block";
            const img = document.createElement("img");
            img.src = e.target.result;
            img.className = "preview-img";
            const removeBtn = document.createElement("span");
            removeBtn.innerHTML = "‚ùå";
            removeBtn.style.cssText = `position: absolute;top: -6px; right: -6px;background: white; color: red;font-weight: bold; border: 1px solid #ccc;border-radius: 50%;padding: 0 5px;cursor: pointer;font-size: 13px;`;
            removeBtn.onclick = () => {totalFiles.splice(index, 1);previewMultiple({ files: totalFiles });};
            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);
            container.appendChild(wrapper);
          container.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
      const dataTransfer = new DataTransfer();
      totalFiles.forEach(file => dataTransfer.items.add(file));
      input.files = dataTransfer.files;
    }
    function showImageModal(src) {document.getElementById("modalImage").src = src;document.getElementById("imageModal").style.display = "flex";}
    function closeImageModal() {document.getElementById("imageModal").style.display = "none";document.getElementById("modalImage").src = "";}
    document.getElementById("chat-form").addEventListener("submit", function (e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData();
      const input = document.getElementById("chat-input");
      formData.append("text", input.value);
      formData.append("reply_to", replyingTo ? JSON.stringify(replyingTo) : "");
      totalFiles.forEach(file => formData.append("images", file));
      if (selectedVideoFile) {
      formData.append("video", selectedVideoFile);
    }
      fetch("/chat/send/{{ friend_username }}", {
        method: "POST",
        body: formData
      })
        .then(res => res.json())
        .then(data => {
          if (data.error === "B·∫†N ƒê√É B·ªä CH·∫∂N") {
            alert(" B·∫°n ƒë√£ b·ªã ch·∫∑n, kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn.");
            return;
          }
          if (data.success) {
            const chatBody = document.getElementById("chat-body");
            const div = document.createElement("div");
            div.className = "message me animated-message";
            if (data.message.reply_to) {
              const replyDiv = document.createElement("div");
              replyDiv.style.fontSize = "0.85rem";
              replyDiv.style.borderLeft = "3px solid #00aaff";
              replyDiv.style.paddingLeft = "8px";
              replyDiv.style.marginBottom = "6px";
              replyDiv.style.color = "#555";
              const sender = data.message.reply_to.sender;
              const fullname = data.message.reply_to.fullname;
              const alias = fullname || localStorage.getItem("friend_name_" + sender) || sender;
              replyDiv.innerHTML = `Tr·∫£ l·ªùi <strong>${alias}</strong>: ${data.message.reply_to.text}`;
              div.appendChild(replyDiv);
            }
            if (data.message.image_urls && data.message.image_urls.length) {
              const imgGroup = document.createElement("div");
              imgGroup.style.display = "flex";
              imgGroup.style.flexWrap = "wrap";
              imgGroup.style.gap = "8px";
              data.message.image_urls.forEach(url => {
                const img = document.createElement("img");
                img.src = url;
                img.className = "preview-img";
                img.onclick = () => showImageModal(url);
                imgGroup.appendChild(img);
              });
              div.appendChild(imgGroup);
            }
            if (data.message.text) {
              const textDiv = document.createElement("div");
              textDiv.className = "message-text";
              textDiv.textContent = data.message.text;
              div.appendChild(textDiv);
            }
            if (data.message.voice_url) {
              const audio = document.createElement("audio");
              audio.controls = true;
              audio.style.marginTop = "5px";
              audio.style.maxWidth = "250px";
              const source = document.createElement("source");
              source.src = data.message.voice_url;
              source.type = "audio/webm"; 
              audio.appendChild(source);
              div.appendChild(audio);
            }
            if (data.message.video_url) {
              const video = document.createElement("video");
              video.controls = true;
              video.style.marginTop = "5px";
              video.style.maxWidth = "300px";
              const source = document.createElement("source");
              source.src = data.message.video_url;
              source.type = "video/" + data.message.video_url.split(".").pop();
              video.appendChild(source);
              div.appendChild(video);
            }
            const timeDiv = document.createElement("div");
            timeDiv.className = "message-time";
            timeDiv.textContent = data.message.time;
            div.appendChild(timeDiv);
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
            attachMessageEvents();
            form.reset();
            input.value = "";
            replyingTo = null;
            totalFiles = [];
            selectedVideoFile = null;
            clearVideoPreview(); 
            document.getElementById("reply-preview")?.remove();
            const preview = document.getElementById("preview-container");
            preview.innerHTML = "";
            preview.style.display = "none";
          }
        })
        .catch(err => console.error("Send error:", err));
    });
const friendName = "{{ friend_name | default('') }}";
</script>
<div id="albumModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;background-color: rgba(0,0,0,0.8); z-index:9999; overflow:auto; padding: 20px;"><span onclick="closeAlbumModal()" style="position:absolute; top:20px; right:30px; color:white; font-size:30px; cursor:pointer;">&times;</span>
<h4 style="color: white; margin-bottom: 20px;">Album ·∫£nh</h4>
<div id="albumImages" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
<div style="text-align:center; margin-top: 20px;">
<button id="loadMoreBtn" onclick="loadMoreImages()" class="btn btn-light btn-sm">T·∫£i th√™m ·∫£nh</button>
</div>
</div>
<script>
let allImages = [];let loadedCount = 0;const BATCH_SIZE = 30;
function openAlbumModal(){document.getElementById("albumModal").style.display="block";if(allImages.length===0){fetch("/api/album-images?friend={{ friend_username }}").then(res=>res.json()).then(data=>{allImages=data;loadedCount=0;document.getElementById("albumImages").innerHTML="";loadMoreImages()})}}
function loadMoreImages(){const c=document.getElementById("albumImages");const b=allImages.slice(loadedCount,loadedCount+BATCH_SIZE);b.forEach(i=>{const e=document.createElement("img");e.onclick=()=>showImageModal(i.url);e.src=i.url+"?v="+Math.random();e.onerror=function(){this.style.display="none"};e.style.width="120px";e.style.height="120px";e.style.objectFit="cover";e.style.borderRadius="8px";e.loading="lazy";c.appendChild(e)});loadedCount+=BATCH_SIZE;if(loadedCount>=allImages.length){document.getElementById("loadMoreBtn").style.display="none"}}
function closeAlbumModal() {document.getElementById("albumModal").style.display = "none";allImages = [];loadedCount = 0;document.getElementById("albumImages").innerHTML = ""; document.getElementById("loadMoreBtn").style.display = "block";}
window.addEventListener("click", e => { const m = document.getElementById("albumModal"); if (e.target === m) closeAlbumModal(); });
</script>
<div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;background-color: rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:10000;">
<span onclick="closeImageModal()" style="position:absolute; top:20px; right:30px; color:white; font-size:30px; cursor:pointer;">&times;</span>
<img id="modalImage" src="" style="max-width:90%; max-height:90%; border-radius:10px;">
</div>
<script>
function showImageModal(src) {document.getElementById("modalImage").src = src;document.getElementById("imageModal").style.display = "flex";}
function closeImageModal() { document.getElementById("imageModal").style.display = "none";document.getElementById("modalImage").src = "";}
</script>
<script>
let replyingTo = null;
document.getElementById('reply-preview')?.remove();
window.addEventListener('load', function() {
  const chatBody = document.getElementById("chat-body");
  chatBody.scrollTop = chatBody.scrollHeight;
  const emojiBtn = document.getElementById('emoji-btn');
  const inputBox = document.querySelector('input[name="text"]');
  const picker = new EmojiButton({
    theme: 'auto',
    position: 'top-start'
  });
  emojiBtn.addEventListener('click', () => {
    picker.togglePicker(emojiBtn);
  });
  picker.on('emoji', emoji => {
    inputBox.value += emoji;
    inputBox.focus();
  });
});
const emojiBtn = document.getElementById('emoji-btn');
emojiBtn.addEventListener('click', (e) => {
  const flyingEmoji = document.createElement('div');
  flyingEmoji.className = 'flying-emoji';
  flyingEmoji.textContent = 'üòÑ';
  const rect = emojiBtn.getBoundingClientRect();
  flyingEmoji.style.left = rect.left + rect.width / 2 + 'px';
  flyingEmoji.style.top = rect.top + 'px';
  document.body.appendChild(flyingEmoji);
  flyingEmoji.addEventListener('animationend', () => {
    flyingEmoji.remove();
  });
});
  document.querySelectorAll('.message').forEach(msg => {
    msg.addEventListener('click', () => {
      const msgText = msg.querySelector('.message-text')?.textContent;
      const msgSender = msg.classList.contains('me') ? "{{ username }}" : "{{ friend_username }}";
      const msgId = msg.dataset.msgId;
      if (msgText && msgId) {
        const msgFullname = msg.dataset.fullname || msgSender;
        replyingTo = {
          id: msgId,
          text: msgText,
          sender: msgSender,
          fullname: msgFullname
        };
      document.getElementById('reply-preview')?.remove();
      const preview = document.createElement('div');
      preview.innerHTML = `
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <div>
          Tr·∫£ l·ªùi: <strong>${msgFullname}</strong>: ${msgText}
        </div>
          <button onclick="cancelReply()" style="border:none; background:none; color:#888; font-size:1rem;">‚ùå</button>
        </div>
      `;
      preview.className = "reply-box";
      preview.style.marginBottom = '10px';
      preview.id = "reply-preview";
      document.querySelector('.chat-footer').prepend(preview);
    }
  });
});
function cancelReply() {replyingTo = null;document.getElementById('reply-preview')?.remove();}
</script>
<script>
document.getElementById("chat-input").addEventListener("keydown", function (event) {
  if (event.key === "Enter" && !event.shiftKey) {
    event.preventDefault(); 
    document.querySelector("#chat-form button[type='submit']").click();
  }
});
</script>
<script>
window.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.reply-box').forEach(box => {
    const username = box.dataset.replySender;
    const customName = localStorage.getItem('friend_name_' + username);
    if (customName) {
      const nameEl = box.querySelector('.reply-name');
      if (nameEl) nameEl.textContent = customName;
    }
  });
});
</script>
<script>
  const friendUsername = "{{ friend_username }}";
  let nameEl = document.getElementById('friend-name');
  const editBtn = document.getElementById('edit-name-btn');
  editBtn.addEventListener("click", () => {
    const currentName = nameEl.textContent;
    const input = document.createElement("input");
    input.type = "text";
    input.value = currentName;
    input.id = "friend-name";
    input.style.maxWidth = "150px";
    input.style.padding = "2px 6px";
    input.style.borderRadius = "6px";
    input.style.border = "1px solid #ccc";
    input.style.background = "#111";
    input.style.color = "#fff";
    input.addEventListener("blur", save);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        input.blur();
      }
    });
    nameEl.replaceWith(input);
    input.focus();
    function save() {
      const newName = input.value.trim();
      const newSpan = document.createElement("strong");
      newSpan.id = "friend-name";
      if (newName === "") {
        localStorage.removeItem("friend_name_" + friendUsername);
        newSpan.textContent = "{{ friend.fullname if friend.fullname else friend.name if friend.name else friend_username }}";
      }else {
              localStorage.setItem("friend_name_" + friendUsername, newName);
        newSpan.textContent = newName;
      }
      fetch("/rename", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          target_username: friendUsername,
          nickname: newName
        })
      });
      input.replaceWith(newSpan);
      nameEl = newSpan;
    }
  });
window.addEventListener('load',function(){const friendUsername="{{ friend_username }}";const savedName=localStorage.getItem('friend_name_'+friendUsername);const nameEl=document.getElementById('friend-name');if(savedName&&savedName!==""){nameEl.textContent=savedName;}});
</script>
<script>
  document.getElementById("edit-name-btn").addEventListener("click", function () {
    const friendUsername = "{{ friend_username }}";
    const currentName = document.getElementById("friend-name").textContent;
    const newName = prompt("Nh·∫≠p bi·ªát danh m·ªõi cho ng∆∞·ªùi n√†y:", currentName);
    if (newName !== null) {
      const nameElement = document.getElementById("friend-name");
      if (newName.trim() === "") {
        localStorage.removeItem("friend_name_" + friendUsername);
        nameElement.textContent = "{{ friend.fullname if friend.fullname else friend.name if friend.name else friend_username }}";
    } else {
        localStorage.setItem("friend_name_" + friendUsername, newName.trim());
        nameElement.textContent = newName.trim();
      }
    }
  });
</script>
<div id="chat-settings-popup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.6); z-index:9999; justify-content: center; align-items: center;">
<div style="background:white; padding:20px; border-radius:12px; max-width:400px; width:90%; position:relative;">
<h5>C√†i ƒë·∫∑t ƒëo·∫°n chat v·ªõi {{ friend_name }}</h5>


<ul style="list-style:none; padding:0;">
<li><button class="btn btn-outline-danger w-100 mb-2" onclick="confirmDeleteChat()"> X√≥a to√†n b·ªô ƒëo·∫°n chat.</button></li>
<li><button class="btn btn-outline-secondary w-100 mb-2" onclick="blockUser()"> Ch·∫∑n ng∆∞·ªùi n√†y.</button></li>
<li><button class="btn btn-outline-warning w-100 mb-2" onclick="reportUser('{{ current_user.user_id }}', '{{ friend.user_id }}')">T·ªë c√°o h√†nh vi sai ph·∫°m.</button></li>
<li><button class="btn btn-outline-dark w-100 mb-2" onclick="reportBug()"> B√°o l·ªói chat.</button></li>
</ul>
<button onclick="closeChatSettings()" style="position:absolute; top:10px; right:10px; border:none; background:none; font-size:20px;">&times;</button>
</div>
</div>
<div id="chooseDeleteTypeModal" style="display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5);">
<div style="background:#fff; margin:10% auto; padding:20px; border-radius:12px; max-width:400px; width:90%; position:relative;">
<h5 class="mb-3">B·∫°n mu·ªën xo√° ƒëo·∫°n chat nh∆∞ th·∫ø n√†o?</h5>
<div class="form-check">
<input class="form-check-input" type="radio" name="delete_mode" id="onlyMe" value="one_side" checked>
<label class="form-check-label" for="onlyMe"> Ch·ªâ xo√° b√™n t√¥i</label>
</div>
<div class="form-check mt-2">
<input class="form-check-input" type="radio" name="delete_mode" id="bothSides" value="both_side">
<label class="form-check-label" for="bothSides"> Xo√° cho c·∫£ hai ng∆∞·ªùi</label>
</div>
<div class="mt-4 text-end">
<button class="btn btn-secondary me-2" onclick="closeChooseDeleteType()">Hu·ª∑</button>
<button class="btn btn-danger" onclick="openConfirmDelete()">Ti·∫øp t·ª•c</button>
</div>
<button onclick="closeChooseDeleteType()" style="position:absolute; top:10px; right:14px; border:none; background:none; font-size:20px;">&times;</button>
</div>
</div>
<script>
document.getElementById("chat-settings-btn").addEventListener("click", () => {document.getElementById("chat-settings-popup").style.display = "flex";});
function closeChatSettings() {document.getElementById("chat-settings-popup").style.display = "none";}
function confirmDeleteChat() {closeChatSettings();document.getElementById("chooseDeleteTypeModal").style.display = "block";}
function closeChooseDeleteType() {document.getElementById("chooseDeleteTypeModal").style.display = "none";}
function openConfirmDelete() {const selected = document.querySelector('input[name="delete_mode"]:checked');window.selectedDeleteMode = selected ? selected.value : "one_side";closeChooseDeleteType();document.getElementById("deleteChatModal").style.display = "block";}
function closeDeleteModal() {document.getElementById("deleteChatModal").style.display = "none";}
function performDeleteChat(){const mode=window.selectedDeleteMode||"one_side";fetch("/chat/delete/{{ friend_username }}",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode})}).then(res=>res.json()).then(data=>{if(data.success){document.getElementById("deleteChatModal").style.display="none";showToastSuccess();setTimeout(()=>location.reload(),1600);}});}
function blockUser() {document.getElementById("blockConfirmModal").style.display = "flex";}
function closeBlockConfirm() {document.getElementById("blockConfirmModal").style.display = "none";}
function confirmBlockUser(){fetch("/block_user",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({target:"{{ friend_username }}"})}).then(res=>res.json()).then(data=>{if(data.status==="success"){closeBlockConfirm();showBlockToast();}});}
function showBlockToast(){const toast=document.getElementById("block-toast");toast.style.display="block";setTimeout(()=>{toast.style.opacity="0";setTimeout(()=>{toast.style.display="none";toast.style.opacity="1";},500);},2000);}
function reportUser() { window.location.href = "/gop-y";}
function reportBug() {window.location.href = "/gop-y";}
function showToastSuccess() {const toast = document.getElementById("toast-success");toast.style.display = "block";setTimeout(() => {toast.style.display = "none";}, 1500);}
fetch("/chat/mark_read/{{ friend_username }}",{method:"POST"}).then(res=>res.json()).then(data=>{console.log(" Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc");});
</script>
<div id="deleteChatModal" class="modal" style="display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0.5);">
<div class="modal-content" style="background-color:#fff; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 400px; border-radius: 12px; position: relative;">
<h5 class="mb-3">üóëÔ∏è X√°c nh·∫≠n xo√° ƒëo·∫°n chat?</h5>
<p style="font-size: 0.95rem; color: #444;"> To√†n b·ªô tin nh·∫Øn vƒÉn b·∫£n v√† h√¨nh ·∫£nh trong ƒëo·∫°n chat n√†y s·∫Ω b·ªã xo√° vƒ©nh vi·ªÖn <strong>cho c·∫£ b·∫°n v√† ƒë·ªëi ph∆∞∆°ng</strong>.<br><span style="color: #d00;"><strong>H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</strong></span></p>
<div style="text-align: right; margin-top: 20px;"><button class="btn btn-secondary me-2" onclick="closeDeleteModal()">Hu·ª∑</button> <button class="btn btn-danger" onclick="performDeleteChat()">Xo√° ngay</button></div>
<button onclick="closeDeleteModal()" style="position:absolute; top:10px; right:14px; border:none; background:none; font-size:20px;">&times;</button>
</div>
</div>
<div id="toast-success"style="display: none;position: fixed; top: 50%;left: 50%;transform: translate(-50%, -50%); background: #00c853;color: white;padding: 12px 24px; border-radius: 10px;font-weight: 500;font-size: 1rem;z-index: 99999;box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);">ƒê√£ xo√° ƒëo·∫°n chat!</div>
<div id="blockConfirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;background-color: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center;">
<div style="background:white; padding:20px; border-radius:12px; max-width:400px; width:90%; position:relative;">
<h5>X√°c nh·∫≠n ch·∫∑n</h5>
<p>B·∫°n c√≥ ch·∫Øc mu·ªën ch·∫∑n ng∆∞·ªùi n√†y?</p>
<div style="text-align:right;">
<button class="btn btn-secondary me-2" onclick="closeBlockConfirm()">Hu·ª∑</button>
<button class="btn btn-danger" onclick="confirmBlockUser()">Ch·∫∑n</button>
</div>
<button onclick="closeBlockConfirm()" style="position:absolute; top:10px; right:14px; border:none; background:none; font-size:20px;">&times;</button>
</div>
</div>
<div id="block-toast" style=" display:none;position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);background:#00c853;color:white; padding:12px 24px;border-radius:10px; font-weight:500; font-size:1rem;z-index:99999;box-shadow:0 6px 20px rgba(0,0,0,0.25);"> ƒê√£ ch·∫∑n ng∆∞·ªùi n√†y th√†nh c√¥ng.</div>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
const socket = io();  
socket.emit("join", "{{ username }}");
socket.on("private_message", function(data) {
    const currentFriend = "{{ friend_username }}";
    if (data.from === currentFriend) {
      const chatBody = document.getElementById("chat-body");
      const div = document.createElement("div");
      div.className = "message friend animated-message";
      if (data.image_urls && data.image_urls.length) {
        const imgGroup = document.createElement("div");
        imgGroup.style.display = "flex";
        imgGroup.style.flexWrap = "wrap";
        imgGroup.style.gap = "8px";
        data.image_urls.forEach(url => {
          const img = document.createElement("img");
          img.src = url;
          img.className = "preview-img";
          img.onclick = () => showImageModal(url);
          imgGroup.appendChild(img);
        });
        div.appendChild(imgGroup);
      }
      if (data.reply_to) {
        const replyDiv = document.createElement("div");
        replyDiv.style.fontSize = "0.85rem";
        replyDiv.style.borderLeft = "3px solid #00aaff";
        replyDiv.style.paddingLeft = "8px";
        replyDiv.style.marginBottom = "6px";
        replyDiv.style.color = "#777";
        const sender = data.reply_to.sender;
        const alias = localStorage.getItem("friend_name_" + sender) || sender;
        replyDiv.innerHTML = `Tr·∫£ l·ªùi <strong>${alias}</strong>: ${data.reply_to.text}`;
        div.appendChild(replyDiv);
      }
      if (data.text) {
        const textDiv = document.createElement("div");
        textDiv.className = "message-text";
        textDiv.textContent = data.text;
        div.appendChild(textDiv);
      }
      const timeDiv = document.createElement("div");
      timeDiv.className = "message-time";
      timeDiv.textContent = data.time || "v·ª´a xong";
      div.appendChild(timeDiv);
      chatBody.appendChild(div);
      chatBody.scrollTop = chatBody.scrollHeight;
      attachMessageEvents();
    }
  });
let silenceTimer = null;
let mediaRecorder;
let chunks = [];
let isRecording = false;
let currentStream = null;
const voiceBtn = document.getElementById("voice-btn");
voiceBtn.addEventListener("click", async () => {
  if (isRecording) {
    return;
  }
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    currentStream = stream;
    mediaRecorder = new MediaRecorder(stream);
    chunks = [];
    isRecording = true;
    mediaRecorder.ondataavailable = (e) => {
      if (e.data.size > 0) chunks.push(e.data);
    };
    mediaRecorder.onstop = () => {
      currentStream.getTracks().forEach(track => track.stop());
      const blob = new Blob(chunks, { type: "audio/webm" });
      sendVoice(blob);
      chunks = [];
      isRecording = false;
      voiceBtn.classList.remove("recording");
    };
    const audioCtx = new AudioContext();
    const source = audioCtx.createMediaStreamSource(stream);
    const analyser = audioCtx.createAnalyser();
    source.connect(analyser);
    analyser.fftSize = 2048;
    const dataArray = new Uint8Array(analyser.fftSize);
    const detectSilence = () => {
      analyser.getByteTimeDomainData(dataArray);
      const max = Math.max(...dataArray);
      const min = Math.min(...dataArray);
      const volume = max - min;
      if (volume < 5) {
        if (!silenceTimer) {
          silenceTimer = setTimeout(() => {
            stopRecording();
          }, 3500);
        }
      } else {
        clearTimeout(silenceTimer);
        silenceTimer = null;
      }
      if (isRecording) requestAnimationFrame(detectSilence);
    };
    mediaRecorder.start();
    voiceBtn.classList.add("recording");
    detectSilence();
  } catch (err) {
    console.error(" Kh√¥ng th·ªÉ truy c·∫≠p micro:", err);
    alert("Kh√¥ng th·ªÉ s·ª≠ d·ª•ng micro. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p.");
  }
});
function stopRecording() {if (mediaRecorder && isRecording) {mediaRecorder.stop(); }}
function sendVoice(blob){const formData=new FormData();formData.append("voice",blob,"voice.webm");fetch(`/chat/send/{{ friend_username }}`,{method:"POST",body:formData}).then(res=>res.json()).then(data=>{if(data.success){const chatBody=document.getElementById("chat-body");const div=document.createElement("div");div.className="message me animated-message";const audio=document.createElement("audio");audio.controls=true;audio.style.marginTop="5px";audio.style.maxWidth="250px";const source=document.createElement("source");source.src=data.message.voice_url;source.type="audio/webm";audio.appendChild(source);div.appendChild(audio);const timeDiv=document.createElement("div");timeDiv.className="message-time";timeDiv.textContent=data.message.time;div.appendChild(timeDiv);chatBody.appendChild(div);chatBody.scrollTop=chatBody.scrollHeight;}else{alert("‚ùå G·ª≠i voice th·∫•t b·∫°i.");}}).catch(err=>{console.error(err);alert("‚ùå L·ªói k·∫øt n·ªëi khi g·ª≠i voice.");});}
socket.on("chat_deleted_notice", data => {
  if (data.from !== "{{ friend_username }}") return;
  const chatArea = document.getElementById("chat-body"); 
  if (!chatArea) return;
  const notice = document.createElement("div");
  notice.innerText = " ƒê·ªëi ph∆∞∆°ng v·ª´a xo√° ƒëo·∫°n chat n√†y.";
  notice.style = "text-align: center; color: red; margin: 20px 0; font-weight: bold;";
  notice.id = "delete-notice";
  chatArea.innerHTML = "";
  chatArea.appendChild(notice);
  setTimeout(() => {
    const n = document.getElementById("delete-notice");
    if (n) n.remove();
  }, 2000);
});
let selectedMsgId = null;
let selectedMsgContent = "";
let longPressTimer = null;
let wasLongPress = false;
let isMouseDown = false;
function handleMouseDown(e){isMouseDown=true;longPressTimer=setTimeout(()=>{if(isMouseDown){selectedMsgId=e.currentTarget.dataset.msgId;selectedMsgContent=e.currentTarget.innerText.trim();let preview=selectedMsgContent.length>100?selectedMsgContent.substring(0,100)+"...":selectedMsgContent;document.getElementById("unsend-preview-text").innerText=`‚Äú${preview}‚Äù`;document.getElementById("unsend-confirm-modal").style.display="flex";}},600);}
function handleMouseUp() {isMouseDown = false; clearTimeout(longPressTimer);}
function clearTimer() {isMouseDown = false;clearTimeout(longPressTimer);}
function attachMessageEvents(){document.querySelectorAll('.message.me').forEach(div=>{div.removeEventListener('mousedown',handleMouseDown);div.removeEventListener('mouseup',handleMouseUp);div.removeEventListener('mouseleave',clearTimer);div.addEventListener('mousedown',handleMouseDown);div.addEventListener('mouseup',handleMouseUp);div.addEventListener('mouseleave',clearTimer);});}
window.addEventListener("load", attachMessageEvents);
div.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
function closeUnsendModal() {document.getElementById("unsend-confirm-modal").style.display = "none";selectedMsgId = null;}
function confirmUnsend(){if(!selectedMsgId)return;fetch("/chat/unsend/"+selectedMsgId,{method:"POST"}).then(res=>res.json()).then(data=>{if(data.success){const div=document.getElementById("msg-"+selectedMsgId);if(div){div.innerHTML=`<em style="color:gray;">You have recalled a message.</em>`;}}});closeUnsendModal();}
socket.on("message_unsent", data => {
  const div = document.getElementById("msg-" + data.msg_id);
  if (div) {
    const replyBox = div.querySelector(".reply-box");
    if (replyBox) {
      replyBox.innerHTML = `<em style="color:gray;">Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi.</em>`;
    }
    div.querySelector(".message-text")?.remove();
    div.querySelector(".preview-img")?.remove();
    div.querySelector("audio")?.remove();
    const mine = data.from === "{{ username }}";
    div.insertAdjacentHTML("beforeend", `<em style="color:gray;">${mine ? "You have recalled a message." : "The message has been recalled."}</em>`);
  }
});
function attachMessageEvents(){document.querySelectorAll('.message.me').forEach(div=>{div.removeEventListener('mousedown',handleMouseDown);div.removeEventListener('mouseup',handleMouseUp);div.removeEventListener('mouseleave',clearTimer);div.addEventListener('mousedown',handleMouseDown);div.addEventListener('mouseup',handleMouseUp);div.addEventListener('mouseleave',clearTimer);});}
function handleMouseDown(e){wasLongPress=false;longPressTimer=setTimeout(()=>{wasLongPress=true;selectedMsgId=this.dataset.msgId;selectedMsgContent=this.innerText.trim();let preview=selectedMsgContent.length>100?selectedMsgContent.substring(0,100)+"...":selectedMsgContent;document.getElementById("unsend-preview-text").innerText=`‚Äú${preview}‚Äù`;document.getElementById("unsend-confirm-modal").style.display="flex";},600);}
function handleMouseUp(e) {clearTimeout(longPressTimer);}
function clearTimer() {clearTimeout(longPressTimer);}
</script>
<div id="unsend-confirm-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); z-index:9999; justify-content: center; align-items: center;">
<div style="background:white; padding:20px; border-radius:12px; max-width:400px; width:90%;"><h5 class="mb-3">B·∫°n mu·ªën thu h·ªìi tin nh·∫Øn n√†y?</h5><p id="unsend-preview-text" style="color:#444;"></p>
<div class="mt-3 text-end">
<button class="btn btn-secondary me-2" onclick="closeUnsendModal()">Hu·ª∑</button>
<button class="btn btn-danger" onclick="confirmUnsend()">Thu h·ªìi</button>
</div>
</div>
</div>
<script>
socket.on("private_message", function(data) { if (window.location.pathname.includes("/chat/")) {window.location.reload();  }});
function attachMessageEvents(){document.querySelectorAll('.message.me').forEach(div=>{div.removeEventListener('mousedown',handleMouseDown);div.removeEventListener('mouseup',handleMouseUp);div.removeEventListener('mouseleave',clearTimer);div.addEventListener('mousedown',handleMouseDown);div.addEventListener('mouseup',handleMouseUp);div.addEventListener('mouseleave',clearTimer);});}
function handleMouseUp() {isMouseDown = false;clearTimeout(longPressTimer);}
function clearTimer() {isMouseDown = false;clearTimeout(longPressTimer);}
function handleMouseUp(e) {clearTimeout(longPressTimer);}
function clearTimer() {clearTimeout(longPressTimer);}
window.addEventListener("load", attachMessageEvents);
const emojiColorMap = { "‚ù§Ô∏è": "reacted-red","üòÇ": "reacted-yellow","üò¢": "reacted-blue","ü§î": "reacted-purple","üò°": "reacted-orange"};
function applyReactionDOM(msgId,emoji){const msgDiv=document.getElementById("msg-"+msgId);if(!msgDiv)return;msgDiv.querySelector(".reaction-display")?.remove();msgDiv.classList.remove(...Object.values(emojiColorMap));if(!emoji)return;const el=document.createElement("div");el.className="reaction-display";el.innerText=emoji;el.style.fontSize="14px";el.style.marginTop="4px";msgDiv.appendChild(el);msgDiv.classList.add(emojiColorMap[emoji]);}
function sendReaction(msgId, emoji) {socket.emit("react_message", {msg_id: msgId,emoji: emoji,target: "{{ friend_username }}"});}
let holdStartTime = 0;
let holdThreshold = 400; 
document.querySelectorAll('.reaction-bar .reaction-btn').forEach(btn=>{const emoji=btn.innerText;let spamTimer=null;let msgId=null;btn.addEventListener('mousedown',e=>{msgId=btn.closest('.message').dataset.msgId;holdStartTime=Date.now();spamTimer=setInterval(()=>{spawnFlyingEmoji(e.clientX,e.clientY,emoji);},120);});btn.addEventListener('mouseup',e=>{e.stopPropagation();clearInterval(spamTimer);const holdTime=Date.now()-holdStartTime;if(holdTime<holdThreshold){const msgDiv=document.getElementById("msg-"+msgId);const current=msgDiv.querySelector(".reaction-display")?.innerText;const newEmoji=current===emoji?"":emoji;applyReactionDOM(msgId,newEmoji);sendReaction(msgId,newEmoji);}});btn.addEventListener('mouseleave',()=>clearInterval(spamTimer));});
socket.on("react_update", data => {applyReactionDOM(data.msg_id, data.emoji);});
function spawnFlyingEmoji(x,y,char){const fly=document.createElement('div');fly.className='flying-emoji';fly.textContent=char;fly.style.left=x+'px';fly.style.top=y+'px';document.body.appendChild(fly);fly.addEventListener('animationend',()=>fly.remove());}
function reportUser(myId, targetId) { const url = `/gop-y?category=T·ªë+c√°o+ng∆∞·ªùi+d√πng&user_id=${encodeURIComponent(myId)}&reported_user=${encodeURIComponent(targetId)}`;window.location.href = url;}
let selectedVideoFile = null;
function handleVideoPreview(input){const file=input.files[0];if(!file)return;selectedVideoFile=file;const preview=document.getElementById("preview-video");const source=document.getElementById("preview-video-source");source.src=URL.createObjectURL(file);preview.load();preview.style.display="block";}function clearVideoPreview(){selectedVideoFile=null;const preview=document.getElementById("preview-video");const source=document.getElementById("preview-video-source");source.src="";preview.style.display="none";}</script><script>lucide.createIcons();</script></body></html>